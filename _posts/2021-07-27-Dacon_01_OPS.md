# 1. KBO 타자 OPS 예측
## 1.2. 탐색적 데이터 분석


```python
# 필요 라이브러리 로드
from matplotlib import font_manager, rc
import matplotlib
import matplotlib.pyplot as plt
import seaborn as sns
import pandas as pd
import numpy as np
import platform

if platform.system() == 'Windows':
# 윈도우인 경우 맑은 고딕 폰트 이용
    font_name = font_manager.FontProperties(fname="c:/Windows/Fonts/malgun.ttf"
                                           ).get_name()
    rc('font', family=font_name)
else:    
# Mac 인 경우
    rc('font', family='AppleGothic')

#그래프에서 마이너스 기호가 표시되게 하는 설정입니다.
matplotlib.rcParams['axes.unicode_minus'] = False
```

### 1.2.1. 프리시즌 데이터 분석


```python
# 프리시즌 데이터 로드
preseason_df = pd.read_csv("C:/dacon/ch01/dataset/Pre_Season_Batter.csv")
# 정규시즌 데이터 로드
regular_season_df = pd.read_csv("C:/dacon/ch01/dataset/Regular_Season_Batter.csv")
# 데이터 크기 확인
print(preseason_df.shape)
# 데이터 상단 출력
display(preseason_df.head())
```

    (1393, 29)
    


<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>batter_id</th>
      <th>batter_name</th>
      <th>year</th>
      <th>team</th>
      <th>avg</th>
      <th>G</th>
      <th>AB</th>
      <th>R</th>
      <th>H</th>
      <th>2B</th>
      <th>...</th>
      <th>GDP</th>
      <th>SLG</th>
      <th>OBP</th>
      <th>E</th>
      <th>height/weight</th>
      <th>year_born</th>
      <th>position</th>
      <th>career</th>
      <th>starting_salary</th>
      <th>OPS</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>가르시아</td>
      <td>2018</td>
      <td>LG</td>
      <td>0.350</td>
      <td>7</td>
      <td>20</td>
      <td>1</td>
      <td>7</td>
      <td>1</td>
      <td>...</td>
      <td>1</td>
      <td>0.550</td>
      <td>0.409</td>
      <td>1</td>
      <td>177cm/93kg</td>
      <td>1985년 04월 12일</td>
      <td>내야수(우투우타)</td>
      <td>쿠바 Ciego de Avila Maximo Gomez Baez(대)</td>
      <td>NaN</td>
      <td>0.959</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>강경학</td>
      <td>2011</td>
      <td>한화</td>
      <td>0.000</td>
      <td>4</td>
      <td>2</td>
      <td>2</td>
      <td>0</td>
      <td>0</td>
      <td>...</td>
      <td>0</td>
      <td>0.000</td>
      <td>0.500</td>
      <td>0</td>
      <td>180cm/72kg</td>
      <td>1992년 08월 11일</td>
      <td>내야수(우투좌타)</td>
      <td>광주대성초-광주동성중-광주동성고</td>
      <td>10000만원</td>
      <td>0.500</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1</td>
      <td>강경학</td>
      <td>2014</td>
      <td>한화</td>
      <td>-</td>
      <td>4</td>
      <td>0</td>
      <td>2</td>
      <td>0</td>
      <td>0</td>
      <td>...</td>
      <td>0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0</td>
      <td>180cm/72kg</td>
      <td>1992년 08월 11일</td>
      <td>내야수(우투좌타)</td>
      <td>광주대성초-광주동성중-광주동성고</td>
      <td>10000만원</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1</td>
      <td>강경학</td>
      <td>2015</td>
      <td>한화</td>
      <td>0.130</td>
      <td>10</td>
      <td>23</td>
      <td>3</td>
      <td>3</td>
      <td>0</td>
      <td>...</td>
      <td>0</td>
      <td>0.130</td>
      <td>0.286</td>
      <td>2</td>
      <td>180cm/72kg</td>
      <td>1992년 08월 11일</td>
      <td>내야수(우투좌타)</td>
      <td>광주대성초-광주동성중-광주동성고</td>
      <td>10000만원</td>
      <td>0.416</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1</td>
      <td>강경학</td>
      <td>2016</td>
      <td>한화</td>
      <td>0.188</td>
      <td>14</td>
      <td>32</td>
      <td>4</td>
      <td>6</td>
      <td>1</td>
      <td>...</td>
      <td>0</td>
      <td>0.281</td>
      <td>0.212</td>
      <td>0</td>
      <td>180cm/72kg</td>
      <td>1992년 08월 11일</td>
      <td>내야수(우투좌타)</td>
      <td>광주대성초-광주동성중-광주동성고</td>
      <td>10000만원</td>
      <td>0.493</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 29 columns</p>
</div>



```python
# 데이터 기초통계량 확인
display(preseason_df.describe())
```


<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>batter_id</th>
      <th>year</th>
      <th>G</th>
      <th>AB</th>
      <th>R</th>
      <th>H</th>
      <th>2B</th>
      <th>3B</th>
      <th>HR</th>
      <th>TB</th>
      <th>...</th>
      <th>SB</th>
      <th>CS</th>
      <th>BB</th>
      <th>HBP</th>
      <th>SO</th>
      <th>GDP</th>
      <th>SLG</th>
      <th>OBP</th>
      <th>E</th>
      <th>OPS</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>1393.000000</td>
      <td>1393.000000</td>
      <td>1393.000000</td>
      <td>1393.000000</td>
      <td>1393.000000</td>
      <td>1393.000000</td>
      <td>1393.000000</td>
      <td>1393.000000</td>
      <td>1393.000000</td>
      <td>1393.000000</td>
      <td>...</td>
      <td>1393.000000</td>
      <td>1393.000000</td>
      <td>1393.000000</td>
      <td>1393.000000</td>
      <td>1393.000000</td>
      <td>1393.000000</td>
      <td>1364.000000</td>
      <td>1368.000000</td>
      <td>1393.000000</td>
      <td>1364.000000</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>173.434314</td>
      <td>2013.014358</td>
      <td>8.705671</td>
      <td>19.201723</td>
      <td>2.679828</td>
      <td>5.021536</td>
      <td>0.954774</td>
      <td>0.119885</td>
      <td>0.391960</td>
      <td>7.391960</td>
      <td>...</td>
      <td>0.629576</td>
      <td>0.291457</td>
      <td>1.877961</td>
      <td>0.330223</td>
      <td>3.714286</td>
      <td>0.447236</td>
      <td>0.361012</td>
      <td>0.317912</td>
      <td>0.381910</td>
      <td>0.676924</td>
    </tr>
    <tr>
      <th>std</th>
      <td>94.716851</td>
      <td>4.166757</td>
      <td>5.562686</td>
      <td>13.395946</td>
      <td>2.637212</td>
      <td>4.232584</td>
      <td>1.196904</td>
      <td>0.379976</td>
      <td>0.748557</td>
      <td>6.538787</td>
      <td>...</td>
      <td>1.146854</td>
      <td>0.595522</td>
      <td>2.053392</td>
      <td>0.642204</td>
      <td>3.180884</td>
      <td>0.723364</td>
      <td>0.269892</td>
      <td>0.151489</td>
      <td>0.729521</td>
      <td>0.386933</td>
    </tr>
    <tr>
      <th>min</th>
      <td>0.000000</td>
      <td>2002.000000</td>
      <td>1.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>...</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>99.000000</td>
      <td>2010.000000</td>
      <td>6.000000</td>
      <td>9.000000</td>
      <td>1.000000</td>
      <td>2.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>2.000000</td>
      <td>...</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>1.000000</td>
      <td>0.000000</td>
      <td>0.217000</td>
      <td>0.250000</td>
      <td>0.000000</td>
      <td>0.472000</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>178.000000</td>
      <td>2014.000000</td>
      <td>9.000000</td>
      <td>18.000000</td>
      <td>2.000000</td>
      <td>4.000000</td>
      <td>1.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>6.000000</td>
      <td>...</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>1.000000</td>
      <td>0.000000</td>
      <td>3.000000</td>
      <td>0.000000</td>
      <td>0.344500</td>
      <td>0.333000</td>
      <td>0.000000</td>
      <td>0.675000</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>254.000000</td>
      <td>2017.000000</td>
      <td>11.000000</td>
      <td>28.000000</td>
      <td>4.000000</td>
      <td>8.000000</td>
      <td>2.000000</td>
      <td>0.000000</td>
      <td>1.000000</td>
      <td>11.000000</td>
      <td>...</td>
      <td>1.000000</td>
      <td>0.000000</td>
      <td>3.000000</td>
      <td>1.000000</td>
      <td>5.000000</td>
      <td>1.000000</td>
      <td>0.478000</td>
      <td>0.400000</td>
      <td>1.000000</td>
      <td>0.867000</td>
    </tr>
    <tr>
      <th>max</th>
      <td>344.000000</td>
      <td>2018.000000</td>
      <td>119.000000</td>
      <td>183.000000</td>
      <td>35.000000</td>
      <td>51.000000</td>
      <td>11.000000</td>
      <td>4.000000</td>
      <td>5.000000</td>
      <td>68.000000</td>
      <td>...</td>
      <td>9.000000</td>
      <td>4.000000</td>
      <td>21.000000</td>
      <td>4.000000</td>
      <td>36.000000</td>
      <td>5.000000</td>
      <td>4.000000</td>
      <td>1.000000</td>
      <td>5.000000</td>
      <td>5.000000</td>
    </tr>
  </tbody>
</table>
<p>8 rows × 21 columns</p>
</div>



```python
# 데이터 시각화
preseason_df.hist(figsize=(10,9))
plt.tight_layout() # 그래프 간격 설정
plt.show()
```


    
![png](output_5_0.png)
    



```python
# 정규시즌 데이터에서 2002년 이후의 연도별 기록된 선수의 수
regular_count = regular_season_df.groupby('year')['batter_id'].count().rename('regular')
# 프리시즌 데이터에서 연도별 기록된 선수의 수
preseason_count = preseason_df.groupby('year')['batter_id'].count().rename('preseason')
pd.concat([regular_count,preseason_count, np.round(preseason_count/regular_count,2).rename(
        'ratio')], axis = 1).transpose().loc[:,2002:] # 2002년부터 봅니다.
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>year</th>
      <th>2002</th>
      <th>2003</th>
      <th>2004</th>
      <th>2005</th>
      <th>2006</th>
      <th>2007</th>
      <th>2008</th>
      <th>2009</th>
      <th>2010</th>
      <th>2011</th>
      <th>2012</th>
      <th>2013</th>
      <th>2014</th>
      <th>2015</th>
      <th>2016</th>
      <th>2017</th>
      <th>2018</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>regular</th>
      <td>43.00</td>
      <td>54.00</td>
      <td>68.00</td>
      <td>73.00</td>
      <td>85.00</td>
      <td>98.00</td>
      <td>115.00</td>
      <td>124.00</td>
      <td>130.00</td>
      <td>151.0</td>
      <td>174.0</td>
      <td>194.00</td>
      <td>186.00</td>
      <td>207.00</td>
      <td>213.00</td>
      <td>217.00</td>
      <td>227.0</td>
    </tr>
    <tr>
      <th>preseason</th>
      <td>12.00</td>
      <td>19.00</td>
      <td>28.00</td>
      <td>37.00</td>
      <td>36.00</td>
      <td>43.00</td>
      <td>61.00</td>
      <td>66.00</td>
      <td>72.00</td>
      <td>75.0</td>
      <td>87.0</td>
      <td>104.00</td>
      <td>117.00</td>
      <td>134.00</td>
      <td>153.00</td>
      <td>167.00</td>
      <td>182.0</td>
    </tr>
    <tr>
      <th>ratio</th>
      <td>0.28</td>
      <td>0.35</td>
      <td>0.41</td>
      <td>0.51</td>
      <td>0.42</td>
      <td>0.44</td>
      <td>0.53</td>
      <td>0.53</td>
      <td>0.55</td>
      <td>0.5</td>
      <td>0.5</td>
      <td>0.54</td>
      <td>0.63</td>
      <td>0.65</td>
      <td>0.72</td>
      <td>0.77</td>
      <td>0.8</td>
    </tr>
  </tbody>
</table>
</div>




```python
# 타자의 이름과 연도를 이용해 새로운 인덱스를 생성
regular_season_df['new_idx'] = regular_season_df['batter_name'] + \
                               regular_season_df['year'].apply(str)
preseason_df['new_idx'] = preseason_df['batter_name'] + preseason_df['year'].apply(str)

# 새로운 인덱스의 교집합
intersection_idx = list(set(regular_season_df['new_idx']). \
                        intersection(preseason_df['new_idx']))

# 교집합에 존재하는 데이터만 불러오기
regular_season_new = regular_season_df.loc[
    regular_season_df['new_idx'].apply(lambda x: x in intersection_idx)].copy()
regular_season_new = regular_season_new.sort_values(by = 'new_idx').reset_index(drop=True) 

# 비교를 위해 인덱스로 정렬
preseason_new = preseason_df.loc[preseason_df['new_idx'].apply(
    lambda x: x in intersection_idx)].copy()
preseason_new = preseason_new.sort_values(by = 'new_idx').reset_index(drop=True)

# 검정 코드
print(regular_season_new.shape, preseason_new.shape)
sum(regular_season_new['new_idx'] == preseason_new['new_idx'])
```

    (1358, 30) (1358, 30)
    




    1358




```python
# 정규시즌과 프리시즌의 상관관계 계산
correlation = regular_season_new['OPS'].corr(preseason_new['OPS'])
sns.scatterplot(regular_season_new['OPS'], preseason_new['OPS'])
plt.title('correlation(상관계수): '+str(np.round(correlation,2)), fontsize=20)
plt.xlabel("정규시즌 OPS",fontsize=12)
plt.ylabel("프리시즌 OPS",fontsize=12)
plt.show()
```

    c:\users\sk8er\anaconda3\envs\dacon_ch1\lib\site-packages\seaborn\_decorators.py:36: FutureWarning: Pass the following variables as keyword args: x, y. From version 0.12, the only valid positional argument will be `data`, and passing other arguments without an explicit keyword will result in an error or misinterpretation.
      warnings.warn(
    


    
![png](output_8_1.png)
    


### 1.2.2. 정규시즌 데이터 분석


```python
regular_season_df = pd.read_csv("C:/dacon/ch01/dataset/Regular_Season_Batter.csv")
display(regular_season_df.shape, regular_season_df.head(),regular_season_df.describe())
```


    (2454, 29)



<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>batter_id</th>
      <th>batter_name</th>
      <th>year</th>
      <th>team</th>
      <th>avg</th>
      <th>G</th>
      <th>AB</th>
      <th>R</th>
      <th>H</th>
      <th>2B</th>
      <th>...</th>
      <th>GDP</th>
      <th>SLG</th>
      <th>OBP</th>
      <th>E</th>
      <th>height/weight</th>
      <th>year_born</th>
      <th>position</th>
      <th>career</th>
      <th>starting_salary</th>
      <th>OPS</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>가르시아</td>
      <td>2018</td>
      <td>LG</td>
      <td>0.339</td>
      <td>50</td>
      <td>183</td>
      <td>27</td>
      <td>62</td>
      <td>9</td>
      <td>...</td>
      <td>3</td>
      <td>0.519</td>
      <td>0.383</td>
      <td>9</td>
      <td>177cm/93kg</td>
      <td>1985년 04월 12일</td>
      <td>내야수(우투우타)</td>
      <td>쿠바 Ciego de Avila Maximo Gomez Baez(대)</td>
      <td>NaN</td>
      <td>0.902</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>강경학</td>
      <td>2011</td>
      <td>한화</td>
      <td>0.000</td>
      <td>2</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>...</td>
      <td>0</td>
      <td>0.000</td>
      <td>0.000</td>
      <td>1</td>
      <td>180cm/72kg</td>
      <td>1992년 08월 11일</td>
      <td>내야수(우투좌타)</td>
      <td>광주대성초-광주동성중-광주동성고</td>
      <td>10000만원</td>
      <td>0.000</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1</td>
      <td>강경학</td>
      <td>2014</td>
      <td>한화</td>
      <td>0.221</td>
      <td>41</td>
      <td>86</td>
      <td>11</td>
      <td>19</td>
      <td>2</td>
      <td>...</td>
      <td>1</td>
      <td>0.349</td>
      <td>0.337</td>
      <td>6</td>
      <td>180cm/72kg</td>
      <td>1992년 08월 11일</td>
      <td>내야수(우투좌타)</td>
      <td>광주대성초-광주동성중-광주동성고</td>
      <td>10000만원</td>
      <td>0.686</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1</td>
      <td>강경학</td>
      <td>2015</td>
      <td>한화</td>
      <td>0.257</td>
      <td>120</td>
      <td>311</td>
      <td>50</td>
      <td>80</td>
      <td>7</td>
      <td>...</td>
      <td>3</td>
      <td>0.325</td>
      <td>0.348</td>
      <td>15</td>
      <td>180cm/72kg</td>
      <td>1992년 08월 11일</td>
      <td>내야수(우투좌타)</td>
      <td>광주대성초-광주동성중-광주동성고</td>
      <td>10000만원</td>
      <td>0.673</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1</td>
      <td>강경학</td>
      <td>2016</td>
      <td>한화</td>
      <td>0.158</td>
      <td>46</td>
      <td>101</td>
      <td>16</td>
      <td>16</td>
      <td>3</td>
      <td>...</td>
      <td>5</td>
      <td>0.257</td>
      <td>0.232</td>
      <td>7</td>
      <td>180cm/72kg</td>
      <td>1992년 08월 11일</td>
      <td>내야수(우투좌타)</td>
      <td>광주대성초-광주동성중-광주동성고</td>
      <td>10000만원</td>
      <td>0.489</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 29 columns</p>
</div>



<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>batter_id</th>
      <th>year</th>
      <th>avg</th>
      <th>G</th>
      <th>AB</th>
      <th>R</th>
      <th>H</th>
      <th>2B</th>
      <th>3B</th>
      <th>HR</th>
      <th>...</th>
      <th>SB</th>
      <th>CS</th>
      <th>BB</th>
      <th>HBP</th>
      <th>SO</th>
      <th>GDP</th>
      <th>SLG</th>
      <th>OBP</th>
      <th>E</th>
      <th>OPS</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>2454.000000</td>
      <td>2454.000000</td>
      <td>2428.000000</td>
      <td>2454.000000</td>
      <td>2454.000000</td>
      <td>2454.000000</td>
      <td>2454.000000</td>
      <td>2454.000000</td>
      <td>2454.000000</td>
      <td>2454.000000</td>
      <td>...</td>
      <td>2454.000000</td>
      <td>2454.000000</td>
      <td>2454.000000</td>
      <td>2454.000000</td>
      <td>2454.000000</td>
      <td>2454.000000</td>
      <td>2428.000000</td>
      <td>2430.000000</td>
      <td>2454.000000</td>
      <td>2428.000000</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>178.079462</td>
      <td>2011.614507</td>
      <td>0.237559</td>
      <td>72.535045</td>
      <td>201.514670</td>
      <td>29.912388</td>
      <td>55.988183</td>
      <td>9.863488</td>
      <td>0.957620</td>
      <td>5.504075</td>
      <td>...</td>
      <td>5.290139</td>
      <td>2.335778</td>
      <td>20.943765</td>
      <td>3.424613</td>
      <td>38.596985</td>
      <td>4.603504</td>
      <td>0.343826</td>
      <td>0.306684</td>
      <td>3.676447</td>
      <td>0.649939</td>
    </tr>
    <tr>
      <th>std</th>
      <td>97.557947</td>
      <td>4.992833</td>
      <td>0.098440</td>
      <td>45.093871</td>
      <td>169.537029</td>
      <td>28.778759</td>
      <td>52.253844</td>
      <td>9.871314</td>
      <td>1.647193</td>
      <td>7.989380</td>
      <td>...</td>
      <td>9.088580</td>
      <td>3.194045</td>
      <td>21.206113</td>
      <td>4.132614</td>
      <td>31.801466</td>
      <td>4.713531</td>
      <td>0.163335</td>
      <td>0.111778</td>
      <td>4.585248</td>
      <td>0.261634</td>
    </tr>
    <tr>
      <th>min</th>
      <td>0.000000</td>
      <td>1993.000000</td>
      <td>0.000000</td>
      <td>1.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>...</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>101.250000</td>
      <td>2008.000000</td>
      <td>0.203000</td>
      <td>28.000000</td>
      <td>38.250000</td>
      <td>5.000000</td>
      <td>8.000000</td>
      <td>1.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>...</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>3.000000</td>
      <td>0.000000</td>
      <td>10.000000</td>
      <td>1.000000</td>
      <td>0.267454</td>
      <td>0.272727</td>
      <td>0.000000</td>
      <td>0.546000</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>183.000000</td>
      <td>2013.000000</td>
      <td>0.255000</td>
      <td>79.000000</td>
      <td>163.000000</td>
      <td>21.000000</td>
      <td>40.000000</td>
      <td>7.000000</td>
      <td>0.000000</td>
      <td>2.000000</td>
      <td>...</td>
      <td>2.000000</td>
      <td>1.000000</td>
      <td>14.000000</td>
      <td>2.000000</td>
      <td>33.000000</td>
      <td>3.000000</td>
      <td>0.360124</td>
      <td>0.328592</td>
      <td>2.000000</td>
      <td>0.688637</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>265.000000</td>
      <td>2016.000000</td>
      <td>0.291000</td>
      <td>115.000000</td>
      <td>357.500000</td>
      <td>49.000000</td>
      <td>100.000000</td>
      <td>16.000000</td>
      <td>1.000000</td>
      <td>8.000000</td>
      <td>...</td>
      <td>6.000000</td>
      <td>3.000000</td>
      <td>34.000000</td>
      <td>5.000000</td>
      <td>60.000000</td>
      <td>7.000000</td>
      <td>0.436000</td>
      <td>0.367000</td>
      <td>5.000000</td>
      <td>0.797234</td>
    </tr>
    <tr>
      <th>max</th>
      <td>344.000000</td>
      <td>2018.000000</td>
      <td>1.000000</td>
      <td>144.000000</td>
      <td>600.000000</td>
      <td>135.000000</td>
      <td>201.000000</td>
      <td>47.000000</td>
      <td>17.000000</td>
      <td>53.000000</td>
      <td>...</td>
      <td>84.000000</td>
      <td>21.000000</td>
      <td>108.000000</td>
      <td>27.000000</td>
      <td>161.000000</td>
      <td>24.000000</td>
      <td>3.000000</td>
      <td>1.000000</td>
      <td>30.000000</td>
      <td>4.000000</td>
    </tr>
  </tbody>
</table>
<p>8 rows × 22 columns</p>
</div>



```python
regular_season_df.hist(figsize=(10,9))
plt.tight_layout() # 그래프 간격 설정
plt.show()
```


    
![png](output_11_0.png)
    



```python
plt.figure(figsize=(15,6)) # 그래프 크기 조정
plt.subplot(1,2,1) # 1행 2열의 첫 번째(1행, 1열) 그래프
g = sns.boxplot(x="year", y="OPS", data=regular_season_df, showfliers=False)
g.set_title('연도별 OPS 상자그림', size = 20)
g.set_xticklabels(g.get_xticklabels(),rotation=90)
plt.subplot(1,2,2)
plt.plot(regular_season_df.groupby('year')['OPS'].median())
plt.title('연도별 OPS 중앙값', size = 20)
plt.show()
```


    
![png](output_12_0.png)
    



```python
pd.crosstab(regular_season_df['year'],'count').T
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>year</th>
      <th>1993</th>
      <th>1994</th>
      <th>1995</th>
      <th>1996</th>
      <th>1997</th>
      <th>1998</th>
      <th>1999</th>
      <th>2000</th>
      <th>2001</th>
      <th>2002</th>
      <th>...</th>
      <th>2009</th>
      <th>2010</th>
      <th>2011</th>
      <th>2012</th>
      <th>2013</th>
      <th>2014</th>
      <th>2015</th>
      <th>2016</th>
      <th>2017</th>
      <th>2018</th>
    </tr>
    <tr>
      <th>col_0</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>1</td>
      <td>2</td>
      <td>1</td>
      <td>7</td>
      <td>8</td>
      <td>10</td>
      <td>14</td>
      <td>20</td>
      <td>32</td>
      <td>43</td>
      <td>...</td>
      <td>124</td>
      <td>130</td>
      <td>151</td>
      <td>174</td>
      <td>194</td>
      <td>186</td>
      <td>207</td>
      <td>213</td>
      <td>217</td>
      <td>227</td>
    </tr>
  </tbody>
</table>
<p>1 rows × 26 columns</p>
</div>




```python
# 연도별 팀의 OPS 중앙값 계산
med_OPS_team = regular_season_df.pivot_table(index=['team'], columns='year',
                                             values='OPS', aggfunc='median')
# 2005년 이후에 결측치가 존재하지 않는 팀만 확인
team_idx = med_OPS_team.loc[:,2005:].isna().sum(axis=1) <= 0

plt.plot(med_OPS_team.loc[team_idx,2005:].T)
plt.legend(med_OPS_team.loc[team_idx,2005:].T.columns, 
           loc='center left', bbox_to_anchor=(1, 0.5)) # 그래프 범례를 그래프 밖에 위치
plt.title('팀별 성적')
plt.show()
```


    
![png](output_14_0.png)
    



```python
import re

regular_season_df['weight'] = regular_season_df['height/weight'].apply(
    lambda x: int(re.findall('\d+',x.split('/')[1])[0]) if pd.notnull(x) else x)

regular_season_df['height'] = regular_season_df['height/weight'].apply(
    lambda x: int(re.findall('\d+',x.split('/')[0])[0]) if pd.notnull(x) else x)

print(regular_season_df['height/weight'][0], regular_season_df['height'][0],
      regular_season_df['weight'][0])
```

    177cm/93kg 177.0 93.0
    


```python
# 몸무게/키 계산
regular_season_df['weight_per_height'] = regular_season_df['weight'] / \
                                         regular_season_df['height']
plt.figure(figsize=(15, 5)) # 그래프 크기 조정
plt.subplot(1, 2, 1) # 1행 2열의 첫번째(1행, 1열) 그래프

# 정규시즌과 프리시즌의 상관관계 계산
correlation = regular_season_df['weight_per_height'].corr(regular_season_df['OBP'])
sns.scatterplot(regular_season_df['weight_per_height'], regular_season_df['OBP'])
plt.title("'몸무게/키'와 OBP correlation(상관관계): " + str(np.round(correlation, 2)), \
          fontsize=15)
plt.ylabel('정규시즌 OBP',fontsize=12)
plt.xlabel('몸무게/키', fontsize=12)
plt.subplot(1, 2, 2)

# 정규시즌과 프리시즌의 상관관계 계산
correlation = regular_season_df['weight_per_height'].corr(regular_season_df['SLG'])
sns.scatterplot(regular_season_df['weight_per_height'], regular_season_df['SLG'])
plt.title("'몸무게/키'와 SLG correlation(상관관계): " + str(np.round(correlation, 2)), \
          fontsize=15)
plt.ylabel('정규시즌 SLG', fontsize=12)
plt.xlabel('몸무게/키', fontsize=12)
plt.show()
```

    c:\users\sk8er\anaconda3\envs\dacon_ch1\lib\site-packages\seaborn\_decorators.py:36: FutureWarning: Pass the following variables as keyword args: x, y. From version 0.12, the only valid positional argument will be `data`, and passing other arguments without an explicit keyword will result in an error or misinterpretation.
      warnings.warn(
    c:\users\sk8er\anaconda3\envs\dacon_ch1\lib\site-packages\seaborn\_decorators.py:36: FutureWarning: Pass the following variables as keyword args: x, y. From version 0.12, the only valid positional argument will be `data`, and passing other arguments without an explicit keyword will result in an error or misinterpretation.
      warnings.warn(
    


    
![png](output_16_1.png)
    



```python
regular_season_df['position'].value_counts()
```




    내야수(우투우타)    643
    외야수(우투우타)    230
    외야수(좌투좌타)    201
    포수(우투우타)     189
    외야수(우투좌타)    184
    내야수(우투좌타)    141
    내야수(좌투좌타)     36
    포수(우투좌타)      14
    외야수(우투양타)      7
    내야수(우투양타)      7
    Name: position, dtype: int64




```python
# position
regular_season_df['pos']=regular_season_df['position'].apply(
    lambda x: x.split('(')[0] if pd.notnull(x) else x)

# 우타, 좌타, 양타
regular_season_df['hit_way'] = regular_season_df['position'].apply(
    lambda x: x[-3:-1] if pd.notnull(x) else x)
print(regular_season_df['position'][0], regular_season_df['pos'][0], 
      regular_season_df['hit_way'][0])
```

    내야수(우투우타) 내야수 우타
    


```python
plt.figure(figsize=(15,5)) # 그래프 크기 조정
plt.subplot(1,2,1) # 1행 2열의 첫번째(1행, 1열) 그래프
ax = sns.boxplot(x='pos', y='OPS', data = regular_season_df, showfliers=False)

# position 별 OPS 중앙값
medians = regular_season_df.groupby(['pos'])['OPS'].median().to_dict()

# position별 관측치 수
nobs = regular_season_df['pos'].value_counts().to_dict()

# 키 값을 'n: 값' 형식으로 변환
for key in nobs: nobs[key] = "n: " + str(nobs[key])

# 그래프의 Xticks text 값 얻기
xticks_labels = [item.get_text() for item in ax.get_xticklabels()]

# tick은 tick의 위치, label은 그에 해당하는 text 값
for label in ax.get_xticklabels():
    ax.text(xticks_labels.index(label.get_text()), 
            medians[label.get_text()] + 0.03, nobs[label.get_text()],
            horizontalalignment='center', size='large', color='w', weight='semibold')
    
ax.set_title('포지션별 OPS')

plt.subplot(1,2,2) # 1행 2열의 두 번째(1행, 2열) 그래프
ax = sns.boxplot(x='hit_way', y='OPS', data = regular_season_df, showfliers=False)

# 타자 방향별 OPS 중앙값
medians = regular_season_df.groupby(['hit_way'])['OPS'].median().to_dict()
# 타자 방향 관측치 수
nobs = regular_season_df['hit_way'].value_counts().to_dict()
# 키 값을 'n: 값' 형식으로 변환
for key in nobs: nobs[key] = "n: " + str(nobs[key])

# 그래프의 Xticks text 값 얻기
xticks_labels = [item.get_text() for item in ax.get_xticklabels()]

# tick은 tick의 위치, label은 그에 해당하는 text 값
for label in ax.get_xticklabels():
    ax.text(xticks_labels.index(label.get_text()), medians[label.get_text()] + 0.03,
            nobs[label.get_text()], horizontalalignment='center', size='large',
            color='w', weight='semibold')
ax.set_title('타석방향별 OPS')

plt.show()
```


    
![png](output_19_0.png)
    



```python
regular_season_df['career'].head()
```




    0    쿠바 Ciego de Avila Maximo Gomez Baez(대)
    1                         광주대성초-광주동성중-광주동성고
    2                         광주대성초-광주동성중-광주동성고
    3                         광주대성초-광주동성중-광주동성고
    4                         광주대성초-광주동성중-광주동성고
    Name: career, dtype: object




```python
# career를 split
foreign_country = regular_season_df['career'].apply(
    lambda x: x.replace('-', ' ').split(' ')[0])

# 외국만 추출
foreign_country_list = list(set(foreign_country.apply(
    lambda x: np.nan if '초' in x else x)))

# 결측치 처리
foreign_country_list = [x for x in foreign_country_list if str(x) != 'nan']
foreign_country_list
```




    ['쿠바', '도미니카', '네덜란드', '미국', '캐나다']




```python
regular_season_df['country'] = foreign_country
regular_season_df['country'] = regular_season_df['country'].apply(
    lambda x: x if pd.isnull(x)
                 else ('foreign' if x in foreign_country_list else 'korean'))
regular_season_df[['country']].head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>country</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>foreign</td>
    </tr>
    <tr>
      <th>1</th>
      <td>korean</td>
    </tr>
    <tr>
      <th>2</th>
      <td>korean</td>
    </tr>
    <tr>
      <th>3</th>
      <td>korean</td>
    </tr>
    <tr>
      <th>4</th>
      <td>korean</td>
    </tr>
  </tbody>
</table>
</div>




```python
plt.figure(figsize=(15,5)) # 그래프 크기 조정
ax = sns.boxplot(x='country', y='OPS', data = regular_season_df, showfliers=False)

# 내외국인 별 OPS 중앙값 dict
medians = regular_season_df.groupby(['country'])['OPS'].median().to_dict()
# 내외국인 관측치 수 dict
nobs = regular_season_df['country'].value_counts().to_dict()
# 키 값을 'n: 값' 형식으로 변환 
for key in nobs: nobs[key] = "n: " + str(nobs[key])

# 그래프의 Xticks text 값 얻기
xticks_labels = [item.get_text() for item in ax.get_xticklabels()]
    
for label in ax.get_xticklabels(): # tick은 tick의 위치, label은 그에 해당하는 text 값 
    ax.text(xticks_labels.index(label.get_text()), medians[label.get_text()] + 0.03, \
            nobs[label.get_text()], # x 좌표, y 좌표, 해당 text
            horizontalalignment='center', size='large', color='w', weight='semibold') 
ax.set_title('국적별 OPS')
plt.show()
```


    
![png](output_23_0.png)
    



```python
regular_season_df['starting_salary'].value_counts()
```




    10000만원     177
    6000만원      117
    3000만원      105
    9000만원       97
    5000만원       91
    8000만원       89
    30000만원      74
    4000만원       62
    12000만원      62
    18000만원      54
    7000만원       53
    11000만원      49
    13000만원      48
    20000만원      46
    25000만원      45
    15000만원      41
    16000만원      28
    14000만원      26
    28000만원      20
    43000만원      17
    45000만원      16
    27000만원      15
    21000만원      13
    23000만원      12
    6500만원       10
    33000만원      10
    100000달러      4
    300000달러      3
    50000달러       2
    17000만원       1
    Name: starting_salary, dtype: int64




```python
# 결측치라면 그대로 0으로 두고 ‘만원’이 포함되어 있다면 숫자만 뽑아서 초봉으로 넣어준다. 그외 만 원 단위가 아닌 초봉은 결측치로 처리한다.
regular_season_df['starting_salary'] = regular_season_df['starting_salary'].apply(
    lambda x: x if pd.isnull(x)
                 else(int(re.findall('\d+',x)[0]) if '만원' in x else np.nan))

plt.figure(figsize=(15,5)) # 그래프 크기 조정
plt.subplot(1,2,1) # 1행 2열의 첫 번째(1행, 1열) 그래프
b=sns.distplot(regular_season_df['starting_salary']. \
               loc[regular_season_df['starting_salary'].notnull()], hist=True)
b.set_xlabel("starting salary",fontsize=12)
b.set_title('초봉의 분포', fontsize=20)

plt.subplot(1,2,2) # 1행 2열의 두 번째(1행, 2열) 그래프

# 정규시즌과 프리시즌의 상관관계 계산
correlation = regular_season_df['starting_salary'].corr(regular_season_df['OPS'])
b = sns.scatterplot(regular_season_df['starting_salary'], regular_season_df['OPS'])
b.axes.set_title('correlation(상관계수): '+str(np.round(correlation,2)), fontsize=20)
b.set_ylabel("정규시즌 OPS",fontsize=12)
b.set_xlabel("초봉",fontsize=12)
plt.show()
```

    c:\users\sk8er\anaconda3\envs\dacon_ch1\lib\site-packages\seaborn\distributions.py:2551: FutureWarning: `distplot` is a deprecated function and will be removed in a future version. Please adapt your code to use either `displot` (a figure-level function with similar flexibility) or `histplot` (an axes-level function for histograms).
      warnings.warn(msg, FutureWarning)
    c:\users\sk8er\anaconda3\envs\dacon_ch1\lib\site-packages\seaborn\_decorators.py:36: FutureWarning: Pass the following variables as keyword args: x, y. From version 0.12, the only valid positional argument will be `data`, and passing other arguments without an explicit keyword will result in an error or misinterpretation.
      warnings.warn(
    


    
![png](output_25_1.png)
    


### 1.2.3. 일별 데이터 분석


```python
day_by_day_df = pd.read_csv(
    'C:/dacon/ch01/dataset/Regular_Season_Batter_Day_by_Day_b4.csv')
display(day_by_day_df.shape, day_by_day_df.head())
```


    (112273, 20)



<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>batter_id</th>
      <th>batter_name</th>
      <th>date</th>
      <th>opposing_team</th>
      <th>avg1</th>
      <th>AB</th>
      <th>R</th>
      <th>H</th>
      <th>2B</th>
      <th>3B</th>
      <th>HR</th>
      <th>RBI</th>
      <th>SB</th>
      <th>CS</th>
      <th>BB</th>
      <th>HBP</th>
      <th>SO</th>
      <th>GDP</th>
      <th>avg2</th>
      <th>year</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>가르시아</td>
      <td>3.24</td>
      <td>NC</td>
      <td>0.333</td>
      <td>3</td>
      <td>1</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0.333</td>
      <td>2018</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0</td>
      <td>가르시아</td>
      <td>3.25</td>
      <td>NC</td>
      <td>0.000</td>
      <td>4</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0.143</td>
      <td>2018</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0</td>
      <td>가르시아</td>
      <td>3.27</td>
      <td>넥센</td>
      <td>0.200</td>
      <td>5</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0.167</td>
      <td>2018</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0</td>
      <td>가르시아</td>
      <td>3.28</td>
      <td>넥센</td>
      <td>0.200</td>
      <td>5</td>
      <td>1</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0.176</td>
      <td>2018</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0</td>
      <td>가르시아</td>
      <td>3.29</td>
      <td>넥센</td>
      <td>0.250</td>
      <td>4</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>3</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0.190</td>
      <td>2018</td>
    </tr>
  </tbody>
</table>
</div>



```python
# 날짜(date)를 ‘.’을 기준으로 나누고 첫 번째 값을 월(month)로 지정 
day_by_day_df['month'] = day_by_day_df['date'].apply(lambda x: str(x).split('.')[0])

# 각 연도의 월별 평균 누적 타율(avg2) 계산
agg_df = day_by_day_df.groupby(['year','month'])['avg2'].mean().reset_index()

# pivot_table을 이용해 데이터 변형
agg_df = agg_df.pivot_table(index=['month'], columns='year', values = 'avg2')
agg_df
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>year</th>
      <th>2001</th>
      <th>2002</th>
      <th>2003</th>
      <th>2004</th>
      <th>2005</th>
      <th>2006</th>
      <th>2007</th>
      <th>2008</th>
      <th>2009</th>
      <th>2010</th>
      <th>2011</th>
      <th>2012</th>
      <th>2013</th>
      <th>2014</th>
      <th>2015</th>
      <th>2016</th>
      <th>2017</th>
      <th>2018</th>
    </tr>
    <tr>
      <th>month</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>10</th>
      <td>0.356400</td>
      <td>0.269065</td>
      <td>0.216583</td>
      <td>0.203636</td>
      <td>NaN</td>
      <td>0.260985</td>
      <td>0.249888</td>
      <td>0.249638</td>
      <td>0.033333</td>
      <td>NaN</td>
      <td>0.243526</td>
      <td>0.246949</td>
      <td>0.257841</td>
      <td>0.273537</td>
      <td>0.274042</td>
      <td>0.282547</td>
      <td>0.280289</td>
      <td>0.277482</td>
    </tr>
    <tr>
      <th>3</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.261714</td>
      <td>0.261714</td>
      <td>0.271982</td>
      <td>NaN</td>
      <td>0.239861</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.231236</td>
      <td>0.210598</td>
      <td>0.214485</td>
      <td>0.257857</td>
      <td>0.161979</td>
      <td>0.238015</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0.205217</td>
      <td>0.319792</td>
      <td>0.250296</td>
      <td>0.259663</td>
      <td>0.235317</td>
      <td>0.267106</td>
      <td>0.215703</td>
      <td>0.261531</td>
      <td>0.252546</td>
      <td>0.262953</td>
      <td>0.247133</td>
      <td>0.234199</td>
      <td>0.267994</td>
      <td>0.259918</td>
      <td>0.255175</td>
      <td>0.266711</td>
      <td>0.259430</td>
      <td>0.263953</td>
    </tr>
    <tr>
      <th>5</th>
      <td>0.297157</td>
      <td>0.267990</td>
      <td>0.241491</td>
      <td>0.237954</td>
      <td>0.253527</td>
      <td>0.264283</td>
      <td>0.237329</td>
      <td>0.262535</td>
      <td>0.280842</td>
      <td>0.272934</td>
      <td>0.250877</td>
      <td>0.247844</td>
      <td>0.268355</td>
      <td>0.273899</td>
      <td>0.261307</td>
      <td>0.275240</td>
      <td>0.274374</td>
      <td>0.274083</td>
    </tr>
    <tr>
      <th>6</th>
      <td>0.306926</td>
      <td>0.275867</td>
      <td>0.252290</td>
      <td>0.248800</td>
      <td>0.249913</td>
      <td>0.264392</td>
      <td>0.260600</td>
      <td>0.270766</td>
      <td>0.278781</td>
      <td>0.274791</td>
      <td>0.263264</td>
      <td>0.254577</td>
      <td>0.270533</td>
      <td>0.283480</td>
      <td>0.268999</td>
      <td>0.276307</td>
      <td>0.279060</td>
      <td>0.280630</td>
    </tr>
    <tr>
      <th>7</th>
      <td>0.293171</td>
      <td>0.266650</td>
      <td>0.244230</td>
      <td>0.251973</td>
      <td>0.256396</td>
      <td>0.262464</td>
      <td>0.259171</td>
      <td>0.264870</td>
      <td>0.275054</td>
      <td>0.265501</td>
      <td>0.264829</td>
      <td>0.261513</td>
      <td>0.262812</td>
      <td>0.275677</td>
      <td>0.272685</td>
      <td>0.283192</td>
      <td>0.284565</td>
      <td>0.280817</td>
    </tr>
    <tr>
      <th>8</th>
      <td>0.303489</td>
      <td>0.270481</td>
      <td>0.252319</td>
      <td>0.249460</td>
      <td>0.243570</td>
      <td>0.265369</td>
      <td>0.270258</td>
      <td>0.265173</td>
      <td>0.271796</td>
      <td>0.271075</td>
      <td>0.262048</td>
      <td>0.258069</td>
      <td>0.268122</td>
      <td>0.282025</td>
      <td>0.272377</td>
      <td>0.283105</td>
      <td>0.283283</td>
      <td>0.283923</td>
    </tr>
    <tr>
      <th>9</th>
      <td>0.308636</td>
      <td>0.248333</td>
      <td>0.243780</td>
      <td>0.203953</td>
      <td>0.237058</td>
      <td>0.258794</td>
      <td>0.251022</td>
      <td>0.252942</td>
      <td>0.264468</td>
      <td>0.265312</td>
      <td>0.258500</td>
      <td>0.251232</td>
      <td>0.260571</td>
      <td>0.272411</td>
      <td>0.271629</td>
      <td>0.276513</td>
      <td>0.273213</td>
      <td>0.277841</td>
    </tr>
  </tbody>
</table>
</div>




```python
display(agg_df.iloc[2:, 10:])
plt.plot(agg_df.iloc[2:,10:]) # 2011~2018년 데이터만 이용
plt.legend(agg_df.iloc[2:,10:].columns,
           loc='center left', bbox_to_anchor=(1, 0.5)) # 범례 그래프 밖에 위치
plt.title('연도별 평균 타율')
plt.show()
```


<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>year</th>
      <th>2011</th>
      <th>2012</th>
      <th>2013</th>
      <th>2014</th>
      <th>2015</th>
      <th>2016</th>
      <th>2017</th>
      <th>2018</th>
    </tr>
    <tr>
      <th>month</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>4</th>
      <td>0.247133</td>
      <td>0.234199</td>
      <td>0.267994</td>
      <td>0.259918</td>
      <td>0.255175</td>
      <td>0.266711</td>
      <td>0.259430</td>
      <td>0.263953</td>
    </tr>
    <tr>
      <th>5</th>
      <td>0.250877</td>
      <td>0.247844</td>
      <td>0.268355</td>
      <td>0.273899</td>
      <td>0.261307</td>
      <td>0.275240</td>
      <td>0.274374</td>
      <td>0.274083</td>
    </tr>
    <tr>
      <th>6</th>
      <td>0.263264</td>
      <td>0.254577</td>
      <td>0.270533</td>
      <td>0.283480</td>
      <td>0.268999</td>
      <td>0.276307</td>
      <td>0.279060</td>
      <td>0.280630</td>
    </tr>
    <tr>
      <th>7</th>
      <td>0.264829</td>
      <td>0.261513</td>
      <td>0.262812</td>
      <td>0.275677</td>
      <td>0.272685</td>
      <td>0.283192</td>
      <td>0.284565</td>
      <td>0.280817</td>
    </tr>
    <tr>
      <th>8</th>
      <td>0.262048</td>
      <td>0.258069</td>
      <td>0.268122</td>
      <td>0.282025</td>
      <td>0.272377</td>
      <td>0.283105</td>
      <td>0.283283</td>
      <td>0.283923</td>
    </tr>
    <tr>
      <th>9</th>
      <td>0.258500</td>
      <td>0.251232</td>
      <td>0.260571</td>
      <td>0.272411</td>
      <td>0.271629</td>
      <td>0.276513</td>
      <td>0.273213</td>
      <td>0.277841</td>
    </tr>
  </tbody>
</table>
</div>



    
![png](output_29_1.png)
    


## 1.3. 데이터 전처리


```python
pd.DataFrame(regular_season_df.isna().sum()).transpose()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>batter_id</th>
      <th>batter_name</th>
      <th>year</th>
      <th>team</th>
      <th>avg</th>
      <th>G</th>
      <th>AB</th>
      <th>R</th>
      <th>H</th>
      <th>2B</th>
      <th>...</th>
      <th>position</th>
      <th>career</th>
      <th>starting_salary</th>
      <th>OPS</th>
      <th>weight</th>
      <th>height</th>
      <th>weight_per_height</th>
      <th>pos</th>
      <th>hit_way</th>
      <th>country</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>26</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>...</td>
      <td>802</td>
      <td>0</td>
      <td>1076</td>
      <td>26</td>
      <td>802</td>
      <td>802</td>
      <td>802</td>
      <td>802</td>
      <td>802</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
<p>1 rows × 35 columns</p>
</div>




```python
# 수치형 타입의 변수 저장
numerics = [
    'int16', 'int32', 'int64', 'float16', 'float32', 'float64'] # 모든 numeric(수치형) 타입
num_cols = regular_season_df.select_dtypes(include=numerics).columns

# 수치형 타입 변수 중 결측치가 하나라도 존재하는 행 출력
# isna().sum(axis=1) -> 열 기준의 결측치 개수
# df.loc[]를 통해 결측치 0개 이상 데이터를 추출
regular_season_df.loc[regular_season_df[num_cols].isna().sum(axis=1) > 0,num_cols].head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>batter_id</th>
      <th>year</th>
      <th>avg</th>
      <th>G</th>
      <th>AB</th>
      <th>R</th>
      <th>H</th>
      <th>2B</th>
      <th>3B</th>
      <th>HR</th>
      <th>...</th>
      <th>SO</th>
      <th>GDP</th>
      <th>SLG</th>
      <th>OBP</th>
      <th>E</th>
      <th>starting_salary</th>
      <th>OPS</th>
      <th>weight</th>
      <th>height</th>
      <th>weight_per_height</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>2018</td>
      <td>0.339</td>
      <td>50</td>
      <td>183</td>
      <td>27</td>
      <td>62</td>
      <td>9</td>
      <td>0</td>
      <td>8</td>
      <td>...</td>
      <td>25</td>
      <td>3</td>
      <td>0.519000</td>
      <td>0.383000</td>
      <td>9</td>
      <td>NaN</td>
      <td>0.902000</td>
      <td>93.0</td>
      <td>177.0</td>
      <td>0.525424</td>
    </tr>
    <tr>
      <th>12</th>
      <td>138</td>
      <td>2005</td>
      <td>0.127</td>
      <td>39</td>
      <td>63</td>
      <td>9</td>
      <td>8</td>
      <td>2</td>
      <td>0</td>
      <td>0</td>
      <td>...</td>
      <td>15</td>
      <td>1</td>
      <td>0.158730</td>
      <td>0.256757</td>
      <td>3</td>
      <td>NaN</td>
      <td>0.415487</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>13</th>
      <td>138</td>
      <td>2006</td>
      <td>0.139</td>
      <td>37</td>
      <td>36</td>
      <td>6</td>
      <td>5</td>
      <td>2</td>
      <td>0</td>
      <td>0</td>
      <td>...</td>
      <td>14</td>
      <td>0</td>
      <td>0.194444</td>
      <td>0.326087</td>
      <td>4</td>
      <td>NaN</td>
      <td>0.520531</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>14</th>
      <td>138</td>
      <td>2007</td>
      <td>0.000</td>
      <td>8</td>
      <td>4</td>
      <td>3</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>...</td>
      <td>2</td>
      <td>1</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0</td>
      <td>NaN</td>
      <td>0.000000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>15</th>
      <td>138</td>
      <td>2008</td>
      <td>0.000</td>
      <td>2</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>...</td>
      <td>0</td>
      <td>0</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0</td>
      <td>NaN</td>
      <td>0.000000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 26 columns</p>
</div>




```python
# 수치형 변수에 포함되는 데이터 타입 선정
numerics = ['int16', 'int32', 'int64', 'float16', 'float32', 'float64']

# 정규 시즌 데이터에서 결측치를 0으로 채우기
regular_season_df[regular_season_df.select_dtypes(include=numerics).columns] = \
    regular_season_df[regular_season_df.select_dtypes(include=numerics).columns].fillna(0)
regular_season_df
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>batter_id</th>
      <th>batter_name</th>
      <th>year</th>
      <th>team</th>
      <th>avg</th>
      <th>G</th>
      <th>AB</th>
      <th>R</th>
      <th>H</th>
      <th>2B</th>
      <th>...</th>
      <th>position</th>
      <th>career</th>
      <th>starting_salary</th>
      <th>OPS</th>
      <th>weight</th>
      <th>height</th>
      <th>weight_per_height</th>
      <th>pos</th>
      <th>hit_way</th>
      <th>country</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>가르시아</td>
      <td>2018</td>
      <td>LG</td>
      <td>0.339</td>
      <td>50</td>
      <td>183</td>
      <td>27</td>
      <td>62</td>
      <td>9</td>
      <td>...</td>
      <td>내야수(우투우타)</td>
      <td>쿠바 Ciego de Avila Maximo Gomez Baez(대)</td>
      <td>0.0</td>
      <td>0.902</td>
      <td>93.0</td>
      <td>177.0</td>
      <td>0.525424</td>
      <td>내야수</td>
      <td>우타</td>
      <td>foreign</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>강경학</td>
      <td>2011</td>
      <td>한화</td>
      <td>0.000</td>
      <td>2</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>...</td>
      <td>내야수(우투좌타)</td>
      <td>광주대성초-광주동성중-광주동성고</td>
      <td>10000.0</td>
      <td>0.000</td>
      <td>72.0</td>
      <td>180.0</td>
      <td>0.400000</td>
      <td>내야수</td>
      <td>좌타</td>
      <td>korean</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1</td>
      <td>강경학</td>
      <td>2014</td>
      <td>한화</td>
      <td>0.221</td>
      <td>41</td>
      <td>86</td>
      <td>11</td>
      <td>19</td>
      <td>2</td>
      <td>...</td>
      <td>내야수(우투좌타)</td>
      <td>광주대성초-광주동성중-광주동성고</td>
      <td>10000.0</td>
      <td>0.686</td>
      <td>72.0</td>
      <td>180.0</td>
      <td>0.400000</td>
      <td>내야수</td>
      <td>좌타</td>
      <td>korean</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1</td>
      <td>강경학</td>
      <td>2015</td>
      <td>한화</td>
      <td>0.257</td>
      <td>120</td>
      <td>311</td>
      <td>50</td>
      <td>80</td>
      <td>7</td>
      <td>...</td>
      <td>내야수(우투좌타)</td>
      <td>광주대성초-광주동성중-광주동성고</td>
      <td>10000.0</td>
      <td>0.673</td>
      <td>72.0</td>
      <td>180.0</td>
      <td>0.400000</td>
      <td>내야수</td>
      <td>좌타</td>
      <td>korean</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1</td>
      <td>강경학</td>
      <td>2016</td>
      <td>한화</td>
      <td>0.158</td>
      <td>46</td>
      <td>101</td>
      <td>16</td>
      <td>16</td>
      <td>3</td>
      <td>...</td>
      <td>내야수(우투좌타)</td>
      <td>광주대성초-광주동성중-광주동성고</td>
      <td>10000.0</td>
      <td>0.489</td>
      <td>72.0</td>
      <td>180.0</td>
      <td>0.400000</td>
      <td>내야수</td>
      <td>좌타</td>
      <td>korean</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>2449</th>
      <td>344</td>
      <td>황진수</td>
      <td>2014</td>
      <td>롯데</td>
      <td>0.000</td>
      <td>5</td>
      <td>5</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>...</td>
      <td>내야수(우투양타)</td>
      <td>석천초-대헌중-공주고</td>
      <td>4000.0</td>
      <td>0.000</td>
      <td>82.0</td>
      <td>181.0</td>
      <td>0.453039</td>
      <td>내야수</td>
      <td>양타</td>
      <td>korean</td>
    </tr>
    <tr>
      <th>2450</th>
      <td>344</td>
      <td>황진수</td>
      <td>2015</td>
      <td>롯데</td>
      <td>0.000</td>
      <td>2</td>
      <td>2</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>...</td>
      <td>내야수(우투양타)</td>
      <td>석천초-대헌중-공주고</td>
      <td>4000.0</td>
      <td>0.000</td>
      <td>82.0</td>
      <td>181.0</td>
      <td>0.453039</td>
      <td>내야수</td>
      <td>양타</td>
      <td>korean</td>
    </tr>
    <tr>
      <th>2451</th>
      <td>344</td>
      <td>황진수</td>
      <td>2016</td>
      <td>롯데</td>
      <td>0.000</td>
      <td>11</td>
      <td>10</td>
      <td>2</td>
      <td>0</td>
      <td>0</td>
      <td>...</td>
      <td>내야수(우투양타)</td>
      <td>석천초-대헌중-공주고</td>
      <td>4000.0</td>
      <td>0.000</td>
      <td>82.0</td>
      <td>181.0</td>
      <td>0.453039</td>
      <td>내야수</td>
      <td>양타</td>
      <td>korean</td>
    </tr>
    <tr>
      <th>2452</th>
      <td>344</td>
      <td>황진수</td>
      <td>2017</td>
      <td>롯데</td>
      <td>0.291</td>
      <td>60</td>
      <td>117</td>
      <td>18</td>
      <td>34</td>
      <td>6</td>
      <td>...</td>
      <td>내야수(우투양타)</td>
      <td>석천초-대헌중-공주고</td>
      <td>4000.0</td>
      <td>0.761</td>
      <td>82.0</td>
      <td>181.0</td>
      <td>0.453039</td>
      <td>내야수</td>
      <td>양타</td>
      <td>korean</td>
    </tr>
    <tr>
      <th>2453</th>
      <td>344</td>
      <td>황진수</td>
      <td>2018</td>
      <td>롯데</td>
      <td>0.167</td>
      <td>18</td>
      <td>24</td>
      <td>6</td>
      <td>4</td>
      <td>1</td>
      <td>...</td>
      <td>내야수(우투양타)</td>
      <td>석천초-대헌중-공주고</td>
      <td>4000.0</td>
      <td>0.564</td>
      <td>82.0</td>
      <td>181.0</td>
      <td>0.453039</td>
      <td>내야수</td>
      <td>양타</td>
      <td>korean</td>
    </tr>
  </tbody>
</table>
<p>2454 rows × 35 columns</p>
</div>




```python
# 일별 데이터에서 결측치를 0으로 채우기
day_by_day_df[day_by_day_df.select_dtypes(include=numerics).columns] = \
    day_by_day_df[day_by_day_df.select_dtypes(include=numerics).columns].fillna(0)
day_by_day_df
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>batter_id</th>
      <th>batter_name</th>
      <th>date</th>
      <th>opposing_team</th>
      <th>avg1</th>
      <th>AB</th>
      <th>R</th>
      <th>H</th>
      <th>2B</th>
      <th>3B</th>
      <th>...</th>
      <th>RBI</th>
      <th>SB</th>
      <th>CS</th>
      <th>BB</th>
      <th>HBP</th>
      <th>SO</th>
      <th>GDP</th>
      <th>avg2</th>
      <th>year</th>
      <th>month</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>가르시아</td>
      <td>3.24</td>
      <td>NC</td>
      <td>0.333</td>
      <td>3</td>
      <td>1</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>...</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0.333</td>
      <td>2018</td>
      <td>3</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0</td>
      <td>가르시아</td>
      <td>3.25</td>
      <td>NC</td>
      <td>0.000</td>
      <td>4</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>...</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0.143</td>
      <td>2018</td>
      <td>3</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0</td>
      <td>가르시아</td>
      <td>3.27</td>
      <td>넥센</td>
      <td>0.200</td>
      <td>5</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>...</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0.167</td>
      <td>2018</td>
      <td>3</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0</td>
      <td>가르시아</td>
      <td>3.28</td>
      <td>넥센</td>
      <td>0.200</td>
      <td>5</td>
      <td>1</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>...</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0.176</td>
      <td>2018</td>
      <td>3</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0</td>
      <td>가르시아</td>
      <td>3.29</td>
      <td>넥센</td>
      <td>0.250</td>
      <td>4</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>...</td>
      <td>3</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0.190</td>
      <td>2018</td>
      <td>3</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>112268</th>
      <td>344</td>
      <td>황진수</td>
      <td>6.23</td>
      <td>LG</td>
      <td>-</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>...</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0.158</td>
      <td>2018</td>
      <td>6</td>
    </tr>
    <tr>
      <th>112269</th>
      <td>344</td>
      <td>황진수</td>
      <td>6.26</td>
      <td>넥센</td>
      <td>0.000</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>...</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0.150</td>
      <td>2018</td>
      <td>6</td>
    </tr>
    <tr>
      <th>112270</th>
      <td>344</td>
      <td>황진수</td>
      <td>6.27</td>
      <td>넥센</td>
      <td>0.500</td>
      <td>2</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>0</td>
      <td>...</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0.182</td>
      <td>2018</td>
      <td>6</td>
    </tr>
    <tr>
      <th>112271</th>
      <td>344</td>
      <td>황진수</td>
      <td>6.28</td>
      <td>넥센</td>
      <td>-</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>...</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0.182</td>
      <td>2018</td>
      <td>6</td>
    </tr>
    <tr>
      <th>112272</th>
      <td>344</td>
      <td>황진수</td>
      <td>6.30</td>
      <td>한화</td>
      <td>0.000</td>
      <td>2</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>...</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0.167</td>
      <td>2018</td>
      <td>6</td>
    </tr>
  </tbody>
</table>
<p>112273 rows × 21 columns</p>
</div>




```python
# 프리시즌 데이터에서 결측치를 0으로 채우기
preseason_df[preseason_df.select_dtypes(include=numerics).columns] = \
    preseason_df[preseason_df.select_dtypes(include=numerics).columns].fillna(0)
preseason_df
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>batter_id</th>
      <th>batter_name</th>
      <th>year</th>
      <th>team</th>
      <th>avg</th>
      <th>G</th>
      <th>AB</th>
      <th>R</th>
      <th>H</th>
      <th>2B</th>
      <th>...</th>
      <th>SLG</th>
      <th>OBP</th>
      <th>E</th>
      <th>height/weight</th>
      <th>year_born</th>
      <th>position</th>
      <th>career</th>
      <th>starting_salary</th>
      <th>OPS</th>
      <th>new_idx</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>가르시아</td>
      <td>2018</td>
      <td>LG</td>
      <td>0.350</td>
      <td>7</td>
      <td>20</td>
      <td>1</td>
      <td>7</td>
      <td>1</td>
      <td>...</td>
      <td>0.550</td>
      <td>0.409</td>
      <td>1</td>
      <td>177cm/93kg</td>
      <td>1985년 04월 12일</td>
      <td>내야수(우투우타)</td>
      <td>쿠바 Ciego de Avila Maximo Gomez Baez(대)</td>
      <td>NaN</td>
      <td>0.959</td>
      <td>가르시아2018</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>강경학</td>
      <td>2011</td>
      <td>한화</td>
      <td>0.000</td>
      <td>4</td>
      <td>2</td>
      <td>2</td>
      <td>0</td>
      <td>0</td>
      <td>...</td>
      <td>0.000</td>
      <td>0.500</td>
      <td>0</td>
      <td>180cm/72kg</td>
      <td>1992년 08월 11일</td>
      <td>내야수(우투좌타)</td>
      <td>광주대성초-광주동성중-광주동성고</td>
      <td>10000만원</td>
      <td>0.500</td>
      <td>강경학2011</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1</td>
      <td>강경학</td>
      <td>2014</td>
      <td>한화</td>
      <td>-</td>
      <td>4</td>
      <td>0</td>
      <td>2</td>
      <td>0</td>
      <td>0</td>
      <td>...</td>
      <td>0.000</td>
      <td>0.000</td>
      <td>0</td>
      <td>180cm/72kg</td>
      <td>1992년 08월 11일</td>
      <td>내야수(우투좌타)</td>
      <td>광주대성초-광주동성중-광주동성고</td>
      <td>10000만원</td>
      <td>0.000</td>
      <td>강경학2014</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1</td>
      <td>강경학</td>
      <td>2015</td>
      <td>한화</td>
      <td>0.130</td>
      <td>10</td>
      <td>23</td>
      <td>3</td>
      <td>3</td>
      <td>0</td>
      <td>...</td>
      <td>0.130</td>
      <td>0.286</td>
      <td>2</td>
      <td>180cm/72kg</td>
      <td>1992년 08월 11일</td>
      <td>내야수(우투좌타)</td>
      <td>광주대성초-광주동성중-광주동성고</td>
      <td>10000만원</td>
      <td>0.416</td>
      <td>강경학2015</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1</td>
      <td>강경학</td>
      <td>2016</td>
      <td>한화</td>
      <td>0.188</td>
      <td>14</td>
      <td>32</td>
      <td>4</td>
      <td>6</td>
      <td>1</td>
      <td>...</td>
      <td>0.281</td>
      <td>0.212</td>
      <td>0</td>
      <td>180cm/72kg</td>
      <td>1992년 08월 11일</td>
      <td>내야수(우투좌타)</td>
      <td>광주대성초-광주동성중-광주동성고</td>
      <td>10000만원</td>
      <td>0.493</td>
      <td>강경학2016</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>1388</th>
      <td>342</td>
      <td>황재균</td>
      <td>2014</td>
      <td>롯데</td>
      <td>0.407</td>
      <td>10</td>
      <td>27</td>
      <td>3</td>
      <td>11</td>
      <td>2</td>
      <td>...</td>
      <td>0.593</td>
      <td>0.448</td>
      <td>1</td>
      <td>183cm/96kg</td>
      <td>1987년 07월 28일</td>
      <td>내야수(우투우타)</td>
      <td>사당초-이수중-경기고-현대-우리-히어로즈-넥센-롯데-샌프란시스코</td>
      <td>6000만원</td>
      <td>1.041</td>
      <td>황재균2014</td>
    </tr>
    <tr>
      <th>1389</th>
      <td>342</td>
      <td>황재균</td>
      <td>2015</td>
      <td>롯데</td>
      <td>0.333</td>
      <td>11</td>
      <td>30</td>
      <td>8</td>
      <td>10</td>
      <td>3</td>
      <td>...</td>
      <td>0.433</td>
      <td>0.389</td>
      <td>0</td>
      <td>183cm/96kg</td>
      <td>1987년 07월 28일</td>
      <td>내야수(우투우타)</td>
      <td>사당초-이수중-경기고-현대-우리-히어로즈-넥센-롯데-샌프란시스코</td>
      <td>6000만원</td>
      <td>0.822</td>
      <td>황재균2015</td>
    </tr>
    <tr>
      <th>1390</th>
      <td>342</td>
      <td>황재균</td>
      <td>2016</td>
      <td>롯데</td>
      <td>0.310</td>
      <td>16</td>
      <td>42</td>
      <td>8</td>
      <td>13</td>
      <td>3</td>
      <td>...</td>
      <td>0.429</td>
      <td>0.370</td>
      <td>1</td>
      <td>183cm/96kg</td>
      <td>1987년 07월 28일</td>
      <td>내야수(우투우타)</td>
      <td>사당초-이수중-경기고-현대-우리-히어로즈-넥센-롯데-샌프란시스코</td>
      <td>6000만원</td>
      <td>0.799</td>
      <td>황재균2016</td>
    </tr>
    <tr>
      <th>1391</th>
      <td>342</td>
      <td>황재균</td>
      <td>2018</td>
      <td>KT</td>
      <td>0.250</td>
      <td>6</td>
      <td>16</td>
      <td>3</td>
      <td>4</td>
      <td>1</td>
      <td>...</td>
      <td>0.500</td>
      <td>0.333</td>
      <td>3</td>
      <td>183cm/96kg</td>
      <td>1987년 07월 28일</td>
      <td>내야수(우투우타)</td>
      <td>사당초-이수중-경기고-현대-우리-히어로즈-넥센-롯데-샌프란시스코</td>
      <td>6000만원</td>
      <td>0.833</td>
      <td>황재균2018</td>
    </tr>
    <tr>
      <th>1392</th>
      <td>344</td>
      <td>황진수</td>
      <td>2014</td>
      <td>롯데</td>
      <td>0.000</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>...</td>
      <td>0.000</td>
      <td>0.000</td>
      <td>0</td>
      <td>181cm/82kg</td>
      <td>1989년 02월 15일</td>
      <td>내야수(우투양타)</td>
      <td>석천초-대헌중-공주고</td>
      <td>4000만원</td>
      <td>0.000</td>
      <td>황진수2014</td>
    </tr>
  </tbody>
</table>
<p>1393 rows × 30 columns</p>
</div>




```python
# 수치형이 아닌 변수 추출
not_num_cols = [x for x in regular_season_df.columns if x not in num_cols]

# 수치형이 아닌 변수 중 결측치가 하나라도 존재하는 행 출력
# isna().sum(axis=1) -> 열 기준의 결측치 개수
# df.loc[]를 통해 결측치 0개 이상 데이터를 추출
regular_season_df.loc[regular_season_df[not_num_cols].isna().sum(axis=1) > 0,
                      not_num_cols].head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>batter_name</th>
      <th>team</th>
      <th>height/weight</th>
      <th>year_born</th>
      <th>position</th>
      <th>career</th>
      <th>pos</th>
      <th>hit_way</th>
      <th>country</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>12</th>
      <td>백승룡</td>
      <td>한화</td>
      <td>NaN</td>
      <td>1982년 08월 16일</td>
      <td>NaN</td>
      <td>사직초(부산극동리틀)-사직중-경남상고-경성대-한화-넥센</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>korean</td>
    </tr>
    <tr>
      <th>13</th>
      <td>백승룡</td>
      <td>한화</td>
      <td>NaN</td>
      <td>1982년 08월 16일</td>
      <td>NaN</td>
      <td>사직초(부산극동리틀)-사직중-경남상고-경성대-한화-넥센</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>korean</td>
    </tr>
    <tr>
      <th>14</th>
      <td>백승룡</td>
      <td>한화</td>
      <td>NaN</td>
      <td>1982년 08월 16일</td>
      <td>NaN</td>
      <td>사직초(부산극동리틀)-사직중-경남상고-경성대-한화-넥센</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>korean</td>
    </tr>
    <tr>
      <th>15</th>
      <td>백승룡</td>
      <td>한화</td>
      <td>NaN</td>
      <td>1982년 08월 16일</td>
      <td>NaN</td>
      <td>사직초(부산극동리틀)-사직중-경남상고-경성대-한화-넥센</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>korean</td>
    </tr>
    <tr>
      <th>16</th>
      <td>백승룡</td>
      <td>한화</td>
      <td>NaN</td>
      <td>1982년 08월 16일</td>
      <td>NaN</td>
      <td>사직초(부산극동리틀)-사직중-경남상고-경성대-한화-넥센</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>korean</td>
    </tr>
  </tbody>
</table>
</div>




```python
# 삭제할 데이터 추출
drop_idx = regular_season_df.loc[
    # 안타가 0개 이상이면서 장타율이 0인 경우
    ((regular_season_df['H'] > 0) & (regular_season_df['SLG']==0)) |
        
    # 안타가 0개 이상 혹은 볼넷이 0개 이상 혹은 몸에 맞은 볼이 0개 이상이면서
    # 출루율이 0인 경우
    (((regular_season_df['H'] > 0) |
      (regular_season_df['BB'] > 0) |
      (regular_season_df['HBP'] > 0)) &
     (regular_season_df['OBP'] == 0))
].index         

# 데이터 삭제
regular_season_df = regular_season_df.drop(drop_idx).reset_index(drop=True)
regular_season_df
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>batter_id</th>
      <th>batter_name</th>
      <th>year</th>
      <th>team</th>
      <th>avg</th>
      <th>G</th>
      <th>AB</th>
      <th>R</th>
      <th>H</th>
      <th>2B</th>
      <th>...</th>
      <th>position</th>
      <th>career</th>
      <th>starting_salary</th>
      <th>OPS</th>
      <th>weight</th>
      <th>height</th>
      <th>weight_per_height</th>
      <th>pos</th>
      <th>hit_way</th>
      <th>country</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>가르시아</td>
      <td>2018</td>
      <td>LG</td>
      <td>0.339</td>
      <td>50</td>
      <td>183</td>
      <td>27</td>
      <td>62</td>
      <td>9</td>
      <td>...</td>
      <td>내야수(우투우타)</td>
      <td>쿠바 Ciego de Avila Maximo Gomez Baez(대)</td>
      <td>0.0</td>
      <td>0.902</td>
      <td>93.0</td>
      <td>177.0</td>
      <td>0.525424</td>
      <td>내야수</td>
      <td>우타</td>
      <td>foreign</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>강경학</td>
      <td>2011</td>
      <td>한화</td>
      <td>0.000</td>
      <td>2</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>...</td>
      <td>내야수(우투좌타)</td>
      <td>광주대성초-광주동성중-광주동성고</td>
      <td>10000.0</td>
      <td>0.000</td>
      <td>72.0</td>
      <td>180.0</td>
      <td>0.400000</td>
      <td>내야수</td>
      <td>좌타</td>
      <td>korean</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1</td>
      <td>강경학</td>
      <td>2014</td>
      <td>한화</td>
      <td>0.221</td>
      <td>41</td>
      <td>86</td>
      <td>11</td>
      <td>19</td>
      <td>2</td>
      <td>...</td>
      <td>내야수(우투좌타)</td>
      <td>광주대성초-광주동성중-광주동성고</td>
      <td>10000.0</td>
      <td>0.686</td>
      <td>72.0</td>
      <td>180.0</td>
      <td>0.400000</td>
      <td>내야수</td>
      <td>좌타</td>
      <td>korean</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1</td>
      <td>강경학</td>
      <td>2015</td>
      <td>한화</td>
      <td>0.257</td>
      <td>120</td>
      <td>311</td>
      <td>50</td>
      <td>80</td>
      <td>7</td>
      <td>...</td>
      <td>내야수(우투좌타)</td>
      <td>광주대성초-광주동성중-광주동성고</td>
      <td>10000.0</td>
      <td>0.673</td>
      <td>72.0</td>
      <td>180.0</td>
      <td>0.400000</td>
      <td>내야수</td>
      <td>좌타</td>
      <td>korean</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1</td>
      <td>강경학</td>
      <td>2016</td>
      <td>한화</td>
      <td>0.158</td>
      <td>46</td>
      <td>101</td>
      <td>16</td>
      <td>16</td>
      <td>3</td>
      <td>...</td>
      <td>내야수(우투좌타)</td>
      <td>광주대성초-광주동성중-광주동성고</td>
      <td>10000.0</td>
      <td>0.489</td>
      <td>72.0</td>
      <td>180.0</td>
      <td>0.400000</td>
      <td>내야수</td>
      <td>좌타</td>
      <td>korean</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>2442</th>
      <td>344</td>
      <td>황진수</td>
      <td>2014</td>
      <td>롯데</td>
      <td>0.000</td>
      <td>5</td>
      <td>5</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>...</td>
      <td>내야수(우투양타)</td>
      <td>석천초-대헌중-공주고</td>
      <td>4000.0</td>
      <td>0.000</td>
      <td>82.0</td>
      <td>181.0</td>
      <td>0.453039</td>
      <td>내야수</td>
      <td>양타</td>
      <td>korean</td>
    </tr>
    <tr>
      <th>2443</th>
      <td>344</td>
      <td>황진수</td>
      <td>2015</td>
      <td>롯데</td>
      <td>0.000</td>
      <td>2</td>
      <td>2</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>...</td>
      <td>내야수(우투양타)</td>
      <td>석천초-대헌중-공주고</td>
      <td>4000.0</td>
      <td>0.000</td>
      <td>82.0</td>
      <td>181.0</td>
      <td>0.453039</td>
      <td>내야수</td>
      <td>양타</td>
      <td>korean</td>
    </tr>
    <tr>
      <th>2444</th>
      <td>344</td>
      <td>황진수</td>
      <td>2016</td>
      <td>롯데</td>
      <td>0.000</td>
      <td>11</td>
      <td>10</td>
      <td>2</td>
      <td>0</td>
      <td>0</td>
      <td>...</td>
      <td>내야수(우투양타)</td>
      <td>석천초-대헌중-공주고</td>
      <td>4000.0</td>
      <td>0.000</td>
      <td>82.0</td>
      <td>181.0</td>
      <td>0.453039</td>
      <td>내야수</td>
      <td>양타</td>
      <td>korean</td>
    </tr>
    <tr>
      <th>2445</th>
      <td>344</td>
      <td>황진수</td>
      <td>2017</td>
      <td>롯데</td>
      <td>0.291</td>
      <td>60</td>
      <td>117</td>
      <td>18</td>
      <td>34</td>
      <td>6</td>
      <td>...</td>
      <td>내야수(우투양타)</td>
      <td>석천초-대헌중-공주고</td>
      <td>4000.0</td>
      <td>0.761</td>
      <td>82.0</td>
      <td>181.0</td>
      <td>0.453039</td>
      <td>내야수</td>
      <td>양타</td>
      <td>korean</td>
    </tr>
    <tr>
      <th>2446</th>
      <td>344</td>
      <td>황진수</td>
      <td>2018</td>
      <td>롯데</td>
      <td>0.167</td>
      <td>18</td>
      <td>24</td>
      <td>6</td>
      <td>4</td>
      <td>1</td>
      <td>...</td>
      <td>내야수(우투양타)</td>
      <td>석천초-대헌중-공주고</td>
      <td>4000.0</td>
      <td>0.564</td>
      <td>82.0</td>
      <td>181.0</td>
      <td>0.453039</td>
      <td>내야수</td>
      <td>양타</td>
      <td>korean</td>
    </tr>
  </tbody>
</table>
<p>2447 rows × 35 columns</p>
</div>



### 1.3.2. 규정 타수 정의


```python
plt.figure(figsize=(6, 3)) # 크기 조정
plt.plot('AB', 'OPS', data=regular_season_df, linestyle='none', marker='o', 
         markersize=2, color='blue', alpha=0.4)
plt.xlabel('AB', fontsize=14)
plt.ylabel('OPS', fontsize=14)
plt.xticks(list(range(min(regular_season_df['AB']), max(regular_season_df['AB']), 30)),
           rotation=90)
plt.vlines(30,ymin=min(regular_season_df['OPS']),ymax=max(regular_season_df['OPS']),
           linestyles='dashed', colors='r')
plt.show()
```


    
![png](output_39_0.png)
    



```python
# OPS 이상치 탐색을 위한 수치 정의
Q1 = regular_season_df['OPS'].quantile(0.25)
Q3 = regular_season_df['OPS'].quantile(0.75)
IQR = Q3 - Q1

# 실제 OPS 이상치 탐색
regular_season_df.loc[(regular_season_df['OPS'] < (Q1 - 1.5 * IQR)) |
                      (regular_season_df['OPS'] > (Q3 + 1.5 * IQR))].sort_values(
    by=['AB'], axis=0, ascending=False)[['batter_name','AB','year','OPS']].head(10)
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>batter_name</th>
      <th>AB</th>
      <th>year</th>
      <th>OPS</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2329</th>
      <td>테임즈</td>
      <td>472</td>
      <td>2015</td>
      <td>1.293656</td>
    </tr>
    <tr>
      <th>97</th>
      <td>강정호</td>
      <td>418</td>
      <td>2014</td>
      <td>1.200156</td>
    </tr>
    <tr>
      <th>1318</th>
      <td>유재신</td>
      <td>33</td>
      <td>2018</td>
      <td>1.192000</td>
    </tr>
    <tr>
      <th>416</th>
      <td>김원섭</td>
      <td>25</td>
      <td>2005</td>
      <td>0.116923</td>
    </tr>
    <tr>
      <th>1543</th>
      <td>이여상</td>
      <td>22</td>
      <td>2013</td>
      <td>0.090909</td>
    </tr>
    <tr>
      <th>681</th>
      <td>문규현</td>
      <td>18</td>
      <td>2007</td>
      <td>0.109000</td>
    </tr>
    <tr>
      <th>578</th>
      <td>김회성</td>
      <td>17</td>
      <td>2010</td>
      <td>0.105000</td>
    </tr>
    <tr>
      <th>1902</th>
      <td>정병곤</td>
      <td>15</td>
      <td>2018</td>
      <td>0.130000</td>
    </tr>
    <tr>
      <th>1874</th>
      <td>정경운</td>
      <td>15</td>
      <td>2018</td>
      <td>0.130000</td>
    </tr>
    <tr>
      <th>2384</th>
      <td>현재윤</td>
      <td>15</td>
      <td>2014</td>
      <td>1.229167</td>
    </tr>
  </tbody>
</table>
</div>




```python
# 7.01~7.31 숫자 생성 후 반 올림
major_ticks = list(np.round(np.linspace(7.01,7.31, 31),2)) 

july = (day_by_day_df['date'] >= 7) & (day_by_day_df['date'] < 8) # 7월만 불러오는 index
plt.plot(major_ticks,
         day_by_day_df['date'].loc[july].value_counts().sort_index(), marker='o')
plt.xticks(major_ticks,rotation=90)
plt.show()
```


    
![png](output_41_0.png)
    


### 1.3.3. 시간 변수


```python
# 시간 변수를 생성하는 함수 정의
def lag_function(df, var_name, past):
    # df = 시간변수를 생성할 데이터 프레임
    # var_name = 시간변수 생성의 대상이 되는 변수 이름
    # past = 몇 년 전의 성적을 생성할지 결정 (정수형)
    df.reset_index(drop=True, inplace = True)
    
    #시간변수 생성
    df['lag'+str(past)+'_'+var_name] = np.nan;
    df['lag'+str(past)+'_'+'AB'] = np.nan
    
    for col in ['AB', var_name]:
        for i in range(0,(max(df.index)+1)):
            val = df.loc[(df['batter_name'] == df['batter_name'][i]) & 
                         (df['year'] == df['year'][i] - past), col]
            # 과거 기록이 결측치가 아니라면 값을 넣기
            if(len(val) != 0):
                df.loc[i, 'lag' + str(past) + '_' + col] = val.iloc[0]

    #30타수 미만 결측치 처리
    df.loc[df['lag' + str(past) + '_' + 'AB'] < 30, 
           'lag' + str(past) + '_' + var_name] = np.nan
    df.drop('lag' + str(past) + '_' + 'AB', axis = 1, inplace = True)

    return df
```


```python
# 상관관계를 탐색할 변수 선택
numerics = ['int16', 'int32', 'int64', 'float16', 'float32', 'float64']
numeric_cols = list(regular_season_df.select_dtypes(include=numerics).drop(
    ['batter_id','year','OPS','SLG'], axis =1).columns)
regular_season_temp = regular_season_df[numeric_cols + ['year', 'batter_name']].copy()
regular_season_temp = regular_season_temp.loc[regular_season_temp['AB'] >= 30]

# 시간변수 생성 함수를 통한 지표별 1년 전 성적 추출
for col in numeric_cols:
    regular_season_temp = lag_function(regular_season_temp, col, 1)

numeric_cols.remove('OBP')
regular_season_temp.drop(numeric_cols, axis = 1, inplace= True)

# 상관관계 도출
corr_matrix = regular_season_temp.corr()
corr_matrix = corr_matrix.sort_values(by = 'OBP', axis = 0, ascending=False)
corr_matrix = corr_matrix[corr_matrix.index]

# 상관관계의 시각적 표현
f, ax = plt.subplots(figsize=(12, 12))
corr = regular_season_temp.select_dtypes(exclude=["object","bool"]).corr()

# 대각 행렬을 기준으로 한 쪽만 나타나게 설정해줍니다.
mask = np.zeros_like(corr_matrix, dtype=np.bool)
mask[np.triu_indices_from(mask)] = True

g = sns.heatmap(corr_matrix, cmap='RdYlGn_r', vmax= 1, mask=mask, 
center=0, annot=True, fmt='.2f', square=True, linewidths=.5, cbar_kws={"shrink": .5})
plt.title("Diagonal Correlation HeatMap")
```




    Text(0.5, 1.0, 'Diagonal Correlation HeatMap')




    
![png](output_44_1.png)
    



```python
#희생 플라이 구하기
#OBP(출루율) 계산 공식 이용하여 SF(희생 플라이)계산 >> (H+BB+HBP)/OBP-(AB+BB+HBP)
regular_season_df['SF'] = \
    regular_season_df[['H','BB','HBP']].sum(axis=1) / regular_season_df['OBP'] - \
    regular_season_df[['AB','BB','HBP']].sum(axis=1)
regular_season_df['SF'].fillna(0, inplace = True)
regular_season_df['SF'] = regular_season_df['SF'].apply(lambda x : round(x,0))

#한 타수당 평균 희생 플라이 계산 후 필요한 것만 추출
regular_season_df['SF_1'] = regular_season_df['SF'] / regular_season_df['AB']
regular_season_df_SF = regular_season_df[['batter_name','year','SF_1']]
regular_season_df_SF
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>batter_name</th>
      <th>year</th>
      <th>SF_1</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>가르시아</td>
      <td>2018</td>
      <td>0.032787</td>
    </tr>
    <tr>
      <th>1</th>
      <td>강경학</td>
      <td>2011</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>2</th>
      <td>강경학</td>
      <td>2014</td>
      <td>-0.000000</td>
    </tr>
    <tr>
      <th>3</th>
      <td>강경학</td>
      <td>2015</td>
      <td>0.009646</td>
    </tr>
    <tr>
      <th>4</th>
      <td>강경학</td>
      <td>2016</td>
      <td>0.009901</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>2442</th>
      <td>황진수</td>
      <td>2014</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>2443</th>
      <td>황진수</td>
      <td>2015</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>2444</th>
      <td>황진수</td>
      <td>2016</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>2445</th>
      <td>황진수</td>
      <td>2017</td>
      <td>0.008547</td>
    </tr>
    <tr>
      <th>2446</th>
      <td>황진수</td>
      <td>2018</td>
      <td>-0.000000</td>
    </tr>
  </tbody>
</table>
<p>2447 rows × 3 columns</p>
</div>




```python
#day_by_day에서 연도별 선수의 시즌 전반기 출루율과 관련된 성적 합 구하기
sum_hf_yr_OBP = day_by_day_df.loc[day_by_day_df['date'] <= 7.18].groupby(
    ['batter_name','year'])['AB','H','BB','HBP'].sum().reset_index()

#day_by_day와 regular season에서 구한 희생 플라이 관련 데이터를 합치기
sum_hf_yr_OBP = sum_hf_yr_OBP.merge(regular_season_df_SF, how = 'left',
                                    on=['batter_name','year'])

#선수별 전반기 희생 플라이 수 계산
sum_hf_yr_OBP['SF'] = (sum_hf_yr_OBP['SF_1']*sum_hf_yr_OBP['AB']).apply(
    lambda x: round(x, 0))
sum_hf_yr_OBP.drop('SF_1', axis = 1, inplace = True)

#선수별 전반기 OBP(출루율) 계산
sum_hf_yr_OBP['OBP'] = sum_hf_yr_OBP[['H', 'BB', 'HBP']].sum(axis = 1) / \
                       sum_hf_yr_OBP[['AB', 'BB', 'HBP','SF']].sum(axis = 1)
# OBP 결측치를 0으로 처리 
sum_hf_yr_OBP['OBP'].fillna(0, inplace = True)

# 분석에 필요하지 않은 열 제거
sum_hf_yr_OBP = sum_hf_yr_OBP[['batter_name','year','AB','OBP']]
sum_hf_yr_OBP
```

    <ipython-input-40-776ced43c63d>:2: FutureWarning: Indexing with multiple keys (implicitly converted to a tuple of keys) will be deprecated, use a list instead.
      sum_hf_yr_OBP = day_by_day_df.loc[day_by_day_df['date'] <= 7.18].groupby(
    




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>batter_name</th>
      <th>year</th>
      <th>AB</th>
      <th>OBP</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>가르시아</td>
      <td>2018</td>
      <td>85</td>
      <td>0.418367</td>
    </tr>
    <tr>
      <th>1</th>
      <td>강경학</td>
      <td>2011</td>
      <td>1</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>2</th>
      <td>강경학</td>
      <td>2014</td>
      <td>0</td>
      <td>1.000000</td>
    </tr>
    <tr>
      <th>3</th>
      <td>강경학</td>
      <td>2015</td>
      <td>156</td>
      <td>0.342541</td>
    </tr>
    <tr>
      <th>4</th>
      <td>강경학</td>
      <td>2016</td>
      <td>81</td>
      <td>0.222222</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>1381</th>
      <td>황진수</td>
      <td>2012</td>
      <td>4</td>
      <td>0.400000</td>
    </tr>
    <tr>
      <th>1382</th>
      <td>황진수</td>
      <td>2013</td>
      <td>0</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>1383</th>
      <td>황진수</td>
      <td>2016</td>
      <td>9</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>1384</th>
      <td>황진수</td>
      <td>2017</td>
      <td>71</td>
      <td>0.316456</td>
    </tr>
    <tr>
      <th>1385</th>
      <td>황진수</td>
      <td>2018</td>
      <td>24</td>
      <td>0.230769</td>
    </tr>
  </tbody>
</table>
<p>1386 rows × 4 columns</p>
</div>



### 1.3.4. 추가 변수 생성


```python
# 나이 변수 생성
regular_season_df['age'] = regular_season_df['year'] - \
                           regular_season_df['year_born'].apply(lambda x: int(x[:4]))

# 나이, 평균 출루율, 출루율 중위값으로 구성된 데이터프레임 구축
temp_df = regular_season_df.loc[regular_season_df['AB'] >= 30].groupby('age').agg(
    {'OBP':['mean','median']}).reset_index()
temp_df.columns = temp_df.columns.droplevel()
temp_df.columns = ['age', 'mean_OBP', 'median_OBP']

# 나이에 따른 출루율 추이 시각화
plt.figure(figsize=(12,8))
plt.plot('age', 'mean_OBP', data=temp_df, marker='o', markerfacecolor='blue',
         markersize=12, color='skyblue', linewidth=4)
plt.ylabel('평균OBP')
plt.xlabel('나이')
plt.show()
```


    
![png](output_48_0.png)
    



```python
# 나이를 포함한 변수 선택
sum_hf_yr_OBP = sum_hf_yr_OBP.merge(regular_season_df[['batter_name','year','age']],
                                    how = 'left', on=['batter_name','year'])

# 총 3년 전 성적까지 변수를 생성
sum_hf_yr_OBP = lag_function(sum_hf_yr_OBP, "OBP", 1)
sum_hf_yr_OBP = lag_function(sum_hf_yr_OBP, "OBP", 2)
sum_hf_yr_OBP = lag_function(sum_hf_yr_OBP, "OBP", 3)
sum_hf_yr_OBP
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>batter_name</th>
      <th>year</th>
      <th>AB</th>
      <th>OBP</th>
      <th>age</th>
      <th>lag1_OBP</th>
      <th>lag2_OBP</th>
      <th>lag3_OBP</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>가르시아</td>
      <td>2018</td>
      <td>85</td>
      <td>0.418367</td>
      <td>33</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1</th>
      <td>강경학</td>
      <td>2011</td>
      <td>1</td>
      <td>0.000000</td>
      <td>19</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2</th>
      <td>강경학</td>
      <td>2014</td>
      <td>0</td>
      <td>1.000000</td>
      <td>22</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>3</th>
      <td>강경학</td>
      <td>2015</td>
      <td>156</td>
      <td>0.342541</td>
      <td>23</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>4</th>
      <td>강경학</td>
      <td>2016</td>
      <td>81</td>
      <td>0.222222</td>
      <td>24</td>
      <td>0.342541</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>1381</th>
      <td>황진수</td>
      <td>2012</td>
      <td>4</td>
      <td>0.400000</td>
      <td>23</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1382</th>
      <td>황진수</td>
      <td>2013</td>
      <td>0</td>
      <td>0.000000</td>
      <td>24</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1383</th>
      <td>황진수</td>
      <td>2016</td>
      <td>9</td>
      <td>0.000000</td>
      <td>27</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1384</th>
      <td>황진수</td>
      <td>2017</td>
      <td>71</td>
      <td>0.316456</td>
      <td>28</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1385</th>
      <td>황진수</td>
      <td>2018</td>
      <td>24</td>
      <td>0.230769</td>
      <td>29</td>
      <td>0.316456</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
<p>1386 rows × 8 columns</p>
</div>



### 1.3.5. 데이터 사후 처리


```python
round(sum_hf_yr_OBP[['lag1_OBP','lag2_OBP','lag3_OBP']].isna().sum() / \
      sum_hf_yr_OBP.shape[0], 2)
```




    lag1_OBP    0.41
    lag2_OBP    0.54
    lag3_OBP    0.61
    dtype: float64




```python
#1. 선수별 OBP 평균
# SF = (H+BB+HBP) / OBP-(AB+BB+HBP)
# OBP = (H+BB+HBP) / (AB+BB+HBP+SF)
player_OBP_mean = regular_season_df.loc[regular_season_df['AB'] >= 30].groupby(
    'batter_name')['AB','H','BB','HBP','SF'].sum().reset_index()
player_OBP_mean['mean_OBP'] = player_OBP_mean[['H', 'BB', 'HBP']].sum(axis=1) / \
                            player_OBP_mean[['AB','BB','HBP','SF']].sum(axis=1)

#2. 시즌별 OBP 평균
season_OBP_mean = regular_season_df.loc[regular_season_df['AB'] >= 30].groupby(
    'year')['AB','H','BB','HBP','SF'].sum().reset_index()
season_OBP_mean['mean_OBP'] = season_OBP_mean[['H', 'BB', 'HBP']].sum(axis=1) / \
                              season_OBP_mean[['AB','BB','HBP','SF']].sum(axis=1)
season_OBP_mean = season_OBP_mean[['year', 'mean_OBP']]

#### player_OBP_mean(선수평균) 열 추가
sum_hf_yr_OBP = sum_hf_yr_OBP.merge(player_OBP_mean[['batter_name', 'mean_OBP']],
                                    how ='left', on="batter_name")
sum_hf_yr_OBP = \
    sum_hf_yr_OBP.loc[~sum_hf_yr_OBP['mean_OBP'].isna()].reset_index(drop=True)
sum_hf_yr_OBP
```

    <ipython-input-44-2eed7c230b60>:4: FutureWarning: Indexing with multiple keys (implicitly converted to a tuple of keys) will be deprecated, use a list instead.
      player_OBP_mean = regular_season_df.loc[regular_season_df['AB'] >= 30].groupby(
    <ipython-input-44-2eed7c230b60>:10: FutureWarning: Indexing with multiple keys (implicitly converted to a tuple of keys) will be deprecated, use a list instead.
      season_OBP_mean = regular_season_df.loc[regular_season_df['AB'] >= 30].groupby(
    




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>batter_name</th>
      <th>year</th>
      <th>AB</th>
      <th>OBP</th>
      <th>age</th>
      <th>lag1_OBP</th>
      <th>lag2_OBP</th>
      <th>lag3_OBP</th>
      <th>mean_OBP</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>가르시아</td>
      <td>2018</td>
      <td>85</td>
      <td>0.418367</td>
      <td>33</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.383495</td>
    </tr>
    <tr>
      <th>1</th>
      <td>강경학</td>
      <td>2011</td>
      <td>1</td>
      <td>0.000000</td>
      <td>19</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.337880</td>
    </tr>
    <tr>
      <th>2</th>
      <td>강경학</td>
      <td>2014</td>
      <td>0</td>
      <td>1.000000</td>
      <td>22</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.337880</td>
    </tr>
    <tr>
      <th>3</th>
      <td>강경학</td>
      <td>2015</td>
      <td>156</td>
      <td>0.342541</td>
      <td>23</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.337880</td>
    </tr>
    <tr>
      <th>4</th>
      <td>강경학</td>
      <td>2016</td>
      <td>81</td>
      <td>0.222222</td>
      <td>24</td>
      <td>0.342541</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.337880</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>1347</th>
      <td>황진수</td>
      <td>2012</td>
      <td>4</td>
      <td>0.400000</td>
      <td>23</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.358779</td>
    </tr>
    <tr>
      <th>1348</th>
      <td>황진수</td>
      <td>2013</td>
      <td>0</td>
      <td>0.000000</td>
      <td>24</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.358779</td>
    </tr>
    <tr>
      <th>1349</th>
      <td>황진수</td>
      <td>2016</td>
      <td>9</td>
      <td>0.000000</td>
      <td>27</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.358779</td>
    </tr>
    <tr>
      <th>1350</th>
      <td>황진수</td>
      <td>2017</td>
      <td>71</td>
      <td>0.316456</td>
      <td>28</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.358779</td>
    </tr>
    <tr>
      <th>1351</th>
      <td>황진수</td>
      <td>2018</td>
      <td>24</td>
      <td>0.230769</td>
      <td>29</td>
      <td>0.316456</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.358779</td>
    </tr>
  </tbody>
</table>
<p>1352 rows × 9 columns</p>
</div>




```python
# 결측치 처리하는 함수 정의
def lag_na_fill(data_set, var_name, past, season_var_mean_data):
    # data_Set: 이용할 데이터셋
    # var_name: 시간 변수를 만들 변수 이름
    # past: 몇 년 전 변수를 만들지 결정
    # season_var_name_mean_data season별로 var_name의 평균을 구한 데이터
  
    for i in range(0,len(data_set)):
        if np.isnan(data_set["lag"+str(past)+"_"+var_name][i]):
            data_set.loc[i,["lag"+str(past)+"_"+var_name]] = (
                data_set["mean" + "_" + var_name][i] + season_var_mean_data.loc[
                    season_var_mean_data['year'] == (data_set['year'][i] - past),
                    "mean_" + var_name].iloc[0]
                ) / 2
    return data_set
```


```python
# 생성한 함수를 이용해 결측치 처리 진행
sum_hf_yr_OBP = lag_na_fill(sum_hf_yr_OBP, "OBP", 1, season_OBP_mean) # 1년 전 성적 대체
sum_hf_yr_OBP = lag_na_fill(sum_hf_yr_OBP, "OBP", 2, season_OBP_mean) # 2년 전 성적 대체
sum_hf_yr_OBP = lag_na_fill(sum_hf_yr_OBP, "OBP", 3, season_OBP_mean) # 3년 전 성적 대체
sum_hf_yr_OBP
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>batter_name</th>
      <th>year</th>
      <th>AB</th>
      <th>OBP</th>
      <th>age</th>
      <th>lag1_OBP</th>
      <th>lag2_OBP</th>
      <th>lag3_OBP</th>
      <th>mean_OBP</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>가르시아</td>
      <td>2018</td>
      <td>85</td>
      <td>0.418367</td>
      <td>33</td>
      <td>0.369982</td>
      <td>0.375910</td>
      <td>0.373119</td>
      <td>0.383495</td>
    </tr>
    <tr>
      <th>1</th>
      <td>강경학</td>
      <td>2011</td>
      <td>1</td>
      <td>0.000000</td>
      <td>19</td>
      <td>0.347434</td>
      <td>0.348603</td>
      <td>0.344259</td>
      <td>0.337880</td>
    </tr>
    <tr>
      <th>2</th>
      <td>강경학</td>
      <td>2014</td>
      <td>0</td>
      <td>1.000000</td>
      <td>22</td>
      <td>0.346682</td>
      <td>0.337511</td>
      <td>0.343131</td>
      <td>0.337880</td>
    </tr>
    <tr>
      <th>3</th>
      <td>강경학</td>
      <td>2015</td>
      <td>156</td>
      <td>0.342541</td>
      <td>23</td>
      <td>0.353425</td>
      <td>0.346682</td>
      <td>0.337511</td>
      <td>0.337880</td>
    </tr>
    <tr>
      <th>4</th>
      <td>강경학</td>
      <td>2016</td>
      <td>81</td>
      <td>0.222222</td>
      <td>24</td>
      <td>0.342541</td>
      <td>0.353425</td>
      <td>0.346682</td>
      <td>0.337880</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>1347</th>
      <td>황진수</td>
      <td>2012</td>
      <td>4</td>
      <td>0.400000</td>
      <td>23</td>
      <td>0.353580</td>
      <td>0.357883</td>
      <td>0.359052</td>
      <td>0.358779</td>
    </tr>
    <tr>
      <th>1348</th>
      <td>황진수</td>
      <td>2013</td>
      <td>0</td>
      <td>0.000000</td>
      <td>24</td>
      <td>0.347960</td>
      <td>0.353580</td>
      <td>0.357883</td>
      <td>0.358779</td>
    </tr>
    <tr>
      <th>1349</th>
      <td>황진수</td>
      <td>2016</td>
      <td>9</td>
      <td>0.000000</td>
      <td>27</td>
      <td>0.360760</td>
      <td>0.363874</td>
      <td>0.357131</td>
      <td>0.358779</td>
    </tr>
    <tr>
      <th>1350</th>
      <td>황진수</td>
      <td>2017</td>
      <td>71</td>
      <td>0.316456</td>
      <td>28</td>
      <td>0.363552</td>
      <td>0.360760</td>
      <td>0.363874</td>
      <td>0.358779</td>
    </tr>
    <tr>
      <th>1351</th>
      <td>황진수</td>
      <td>2018</td>
      <td>24</td>
      <td>0.230769</td>
      <td>29</td>
      <td>0.316456</td>
      <td>0.363552</td>
      <td>0.360760</td>
      <td>0.358779</td>
    </tr>
  </tbody>
</table>
<p>1352 rows × 9 columns</p>
</div>



### 1.3.6. SLG 데이터 전처리


```python
# 상관관계를 탐색할 변수 선택
numerics = ['int16', 'int32', 'int64', 'float16', 'float32', 'float64']
numeric_cols = list(regular_season_df.select_dtypes(include=numerics).drop(
    ['batter_id','year','OPS','OBP'], axis =1).columns)
regular_season_temp = regular_season_df[numeric_cols + ['year', 'batter_name']].copy()
regular_season_temp = regular_season_temp.loc[regular_season_temp['AB']>=30]

# 시간변수 생성 함수를 통한 지표별 1년 전 성적 추출
for col in numeric_cols:
    regular_season_temp = lag_function(regular_season_temp, col, 1)

numeric_cols.remove('SLG')
regular_season_temp.drop(numeric_cols, axis = 1, inplace=True)

# 상관관계 도출
corr_matrix = regular_season_temp.corr()
corr_matrix = corr_matrix.sort_values(by = 'SLG', axis = 0, ascending=False)
corr_matrix = corr_matrix[corr_matrix.index]

# 상관관계의 시각적 표현
f, ax = plt.subplots(figsize=(12, 12))
corr = regular_season_temp.select_dtypes(exclude=["object","bool"]).corr()

# 대각 행렬을 기준으로 한쪽만 나타나게 설정해줍니다.
mask = np.zeros_like(corr_matrix, dtype=np.bool)
mask[np.triu_indices_from(mask)] = True

cmap = sns.diverging_palette(220, 10, as_cmap=True)
g = sns.heatmap(corr_matrix, cmap='RdYlGn_r', vmax=1, mask=mask, center=0, annot=True,
                fmt='.2f', square=True, linewidths=.5, cbar_kws={"shrink": .5})
plt.title("Diagonal Correlation HeatMap")
```




    Text(0.5, 1.0, 'Diagonal Correlation HeatMap')




    
![png](output_56_1.png)
    



```python
# day_by_day에서 연도별 선수의 시즌 전반기 장타율(SLG)과 관련된 성적 합 구하기
sum_hf_yr_SLG = day_by_day_df.loc[day_by_day_df['date'] <= 7.18].groupby(
    ['batter_name','year'])['AB','H','2B','3B', 'HR'].sum().reset_index()

# 전반기 장타율 계산
sum_hf_yr_SLG['SLG'] = \
    (sum_hf_yr_SLG['H'] - sum_hf_yr_SLG[['2B', '3B', 'HR']].sum(axis=1) +
     sum_hf_yr_SLG['2B']*2 + sum_hf_yr_SLG['3B']*3 + sum_hf_yr_SLG['HR']*4
     ) / sum_hf_yr_SLG['AB']

# SLG 결측치를 0으로 처리 
sum_hf_yr_SLG['SLG'].fillna(0, inplace=True)

# 필요한 칼럼만 불러오고 나이 계산
sum_hf_yr_SLG = sum_hf_yr_SLG[['batter_name','year','AB','SLG']]
sum_hf_yr_SLG = sum_hf_yr_SLG.merge(regular_season_df[['batter_name','year','age']],
                                    how='left', on=['batter_name','year'])
sum_hf_yr_SLG.head()
```

    <ipython-input-48-dbd92d982176>:2: FutureWarning: Indexing with multiple keys (implicitly converted to a tuple of keys) will be deprecated, use a list instead.
      sum_hf_yr_SLG = day_by_day_df.loc[day_by_day_df['date'] <= 7.18].groupby(
    




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>batter_name</th>
      <th>year</th>
      <th>AB</th>
      <th>SLG</th>
      <th>age</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>가르시아</td>
      <td>2018</td>
      <td>85</td>
      <td>0.552941</td>
      <td>33</td>
    </tr>
    <tr>
      <th>1</th>
      <td>강경학</td>
      <td>2011</td>
      <td>1</td>
      <td>0.000000</td>
      <td>19</td>
    </tr>
    <tr>
      <th>2</th>
      <td>강경학</td>
      <td>2014</td>
      <td>0</td>
      <td>0.000000</td>
      <td>22</td>
    </tr>
    <tr>
      <th>3</th>
      <td>강경학</td>
      <td>2015</td>
      <td>156</td>
      <td>0.333333</td>
      <td>23</td>
    </tr>
    <tr>
      <th>4</th>
      <td>강경학</td>
      <td>2016</td>
      <td>81</td>
      <td>0.222222</td>
      <td>24</td>
    </tr>
  </tbody>
</table>
</div>




```python
# 총 3년 전 성적까지 변수를 생성
sum_hf_yr_SLG = lag_function(sum_hf_yr_SLG, "SLG", 1)
sum_hf_yr_SLG = lag_function(sum_hf_yr_SLG, "SLG", 2)
sum_hf_yr_SLG = lag_function(sum_hf_yr_SLG, "SLG", 3)
display(sum_hf_yr_SLG.head())

round(sum_hf_yr_SLG[['lag1_SLG', 'lag2_SLG', 'lag3_SLG']].isna().sum()/\
      sum_hf_yr_SLG.shape[0], 2)
```


<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>batter_name</th>
      <th>year</th>
      <th>AB</th>
      <th>SLG</th>
      <th>age</th>
      <th>lag1_SLG</th>
      <th>lag2_SLG</th>
      <th>lag3_SLG</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>가르시아</td>
      <td>2018</td>
      <td>85</td>
      <td>0.552941</td>
      <td>33</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1</th>
      <td>강경학</td>
      <td>2011</td>
      <td>1</td>
      <td>0.000000</td>
      <td>19</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2</th>
      <td>강경학</td>
      <td>2014</td>
      <td>0</td>
      <td>0.000000</td>
      <td>22</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>3</th>
      <td>강경학</td>
      <td>2015</td>
      <td>156</td>
      <td>0.333333</td>
      <td>23</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>4</th>
      <td>강경학</td>
      <td>2016</td>
      <td>81</td>
      <td>0.222222</td>
      <td>24</td>
      <td>0.333333</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
</div>





    lag1_SLG    0.41
    lag2_SLG    0.54
    lag3_SLG    0.61
    dtype: float64




```python
# 선수별 SLG 평균 데이터(player_SLG_mean)를 만듭니다
player_SLG_mean = regular_season_df.loc[regular_season_df['AB'] >= 30].groupby(
    'batter_name')['AB','H','2B','3B','HR'].sum().reset_index()
player_SLG_mean['mean_SLG'] = \
    (player_SLG_mean['H'] - player_SLG_mean[['2B','3B','HR']].sum(axis = 1) +
     player_SLG_mean['2B']*2 + player_SLG_mean['3B']*3 + player_SLG_mean['HR']*4
    ) / player_SLG_mean['AB']

# 시즌별 SLG 평균 데이터(season_SLG_mean)를 만듭니다
season_SLG_mean = regular_season_df.loc[regular_season_df['AB'] >= 30].groupby(
    'year')['AB','H','2B','3B','HR'].sum().reset_index()
season_SLG_mean['mean_SLG'] = \
    (season_SLG_mean['H'] - season_SLG_mean[['2B','3B','HR']].sum(axis = 1) + 
     season_SLG_mean['2B']*2 + season_SLG_mean['3B']*3 + season_SLG_mean['HR']*4
    ) / season_SLG_mean['AB']

# 선수 평균의 SLG(player_OBP_mean)를 새로운 변수로 더합니다.
sum_hf_yr_SLG = sum_hf_yr_SLG.merge(player_SLG_mean[['batter_name', 'mean_SLG']],
                                    how='left', on="batter_name")

# 선수 평균의 성적이 결측치이면 데이터에서 제거합니다.
sum_hf_yr_SLG = \
    sum_hf_yr_SLG.loc[~sum_hf_yr_SLG['mean_SLG'].isna()].reset_index(drop=True)

# 결측치 처리
sum_hf_yr_SLG = lag_na_fill(sum_hf_yr_SLG, "SLG", 1, season_SLG_mean) #1년전 성적 대체
sum_hf_yr_SLG = lag_na_fill(sum_hf_yr_SLG, "SLG", 2, season_SLG_mean) #2년전 성적 대체
sum_hf_yr_SLG = lag_na_fill(sum_hf_yr_SLG, "SLG", 3, season_SLG_mean) #3년전 성적 대체

display(sum_hf_yr_SLG.head())
round(sum_hf_yr_SLG[['lag1_SLG', 'lag2_SLG', 'lag3_SLG']].isna().sum()/\
      sum_hf_yr_SLG.shape[0], 2)
```

    <ipython-input-50-8b68c71317d3>:2: FutureWarning: Indexing with multiple keys (implicitly converted to a tuple of keys) will be deprecated, use a list instead.
      player_SLG_mean = regular_season_df.loc[regular_season_df['AB'] >= 30].groupby(
    <ipython-input-50-8b68c71317d3>:10: FutureWarning: Indexing with multiple keys (implicitly converted to a tuple of keys) will be deprecated, use a list instead.
      season_SLG_mean = regular_season_df.loc[regular_season_df['AB'] >= 30].groupby(
    


<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>batter_name</th>
      <th>year</th>
      <th>AB</th>
      <th>SLG</th>
      <th>age</th>
      <th>lag1_SLG</th>
      <th>lag2_SLG</th>
      <th>lag3_SLG</th>
      <th>mean_SLG</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>가르시아</td>
      <td>2018</td>
      <td>85</td>
      <td>0.552941</td>
      <td>33</td>
      <td>0.481855</td>
      <td>0.481498</td>
      <td>0.476627</td>
      <td>0.519126</td>
    </tr>
    <tr>
      <th>1</th>
      <td>강경학</td>
      <td>2011</td>
      <td>1</td>
      <td>0.000000</td>
      <td>19</td>
      <td>0.372902</td>
      <td>0.380882</td>
      <td>0.361716</td>
      <td>0.332527</td>
    </tr>
    <tr>
      <th>2</th>
      <td>강경학</td>
      <td>2014</td>
      <td>0</td>
      <td>0.000000</td>
      <td>22</td>
      <td>0.362931</td>
      <td>0.349344</td>
      <td>0.359616</td>
      <td>0.332527</td>
    </tr>
    <tr>
      <th>3</th>
      <td>강경학</td>
      <td>2015</td>
      <td>156</td>
      <td>0.333333</td>
      <td>23</td>
      <td>0.389415</td>
      <td>0.362931</td>
      <td>0.349344</td>
      <td>0.332527</td>
    </tr>
    <tr>
      <th>4</th>
      <td>강경학</td>
      <td>2016</td>
      <td>81</td>
      <td>0.222222</td>
      <td>24</td>
      <td>0.333333</td>
      <td>0.389415</td>
      <td>0.362931</td>
      <td>0.332527</td>
    </tr>
  </tbody>
</table>
</div>





    lag1_SLG    0.0
    lag2_SLG    0.0
    lag3_SLG    0.0
    dtype: float64



## 1.4. 모델링
### 1.4.1. 데이터 분할


```python
# 30타수 이상의 데이터만 학습
sum_hf_yr_OBP= sum_hf_yr_OBP.loc[sum_hf_yr_OBP['AB']>=30]
sum_hf_yr_SLG = sum_hf_yr_SLG.loc[sum_hf_yr_SLG['AB']>=30] 

# 2018년 데이터를 test 데이터 2018년 이전은 train 데이터로 나눈다.
OBP_train = sum_hf_yr_OBP.loc[sum_hf_yr_OBP['year'] != 2018]
OBP_test = sum_hf_yr_OBP.loc[sum_hf_yr_OBP['year'] == 2018]

SLG_train = sum_hf_yr_SLG.loc[sum_hf_yr_SLG['year'] != 2018]
SLG_test = sum_hf_yr_SLG.loc[sum_hf_yr_SLG['year'] == 2018]
print(OBP_train.shape, OBP_test.shape, SLG_train.shape, SLG_test.shape)
```

    (872, 9) (150, 9) (872, 9) (150, 9)
    


```python
def wrmse(v,w,p):
    # v: 실제값
    # w: 타수
    # p: 예측값
    return sum(np.sqrt(((v-p)**2 * w) / sum(w)))
```

### 1.4.2. 모델 선택


```python
from sklearn.linear_model import Ridge, Lasso
from sklearn.model_selection import GridSearchCV

# log 단위(1e+01)로 1.e-04 ~ 1.e+01 사이의 구간에 대해 parameter를 탐색한다. 
lasso_params = {'alpha':np.logspace(-4, 1, 6)} 
ridge_params = {'alpha':np.logspace(-4, 1, 6)} 

# GridSearchCV를 이용하여 dict에 Lasso, Ridege OBP 모델을 저장한다.
OBP_linear_models = {
    'Lasso': GridSearchCV(Lasso(), param_grid=lasso_params).fit(
        OBP_train.iloc[:,-5:], OBP_train['OBP']).best_estimator_,
    'Ridge': GridSearchCV(Ridge(), param_grid=ridge_params).fit(
        OBP_train.iloc[:,-5:], OBP_train['OBP']).best_estimator_,}

# GridSearchCV를 이용하여 dict에 Lasso, Ridge SLG 모델을 저장한다
SLG_linear_models = {
    'Lasso': GridSearchCV(Lasso(), param_grid=lasso_params).fit(
        SLG_train.iloc[:,-5:], SLG_train['SLG']).best_estimator_,
    'Ridge': GridSearchCV(Ridge(),param_grid=ridge_params).fit(
        SLG_train.iloc[:,-5:], SLG_train['SLG']).best_estimator_,}
```


```python
import time
from sklearn.ensemble import RandomForestRegressor 
start = time.time() # 시작 시간 저장

# 랜덤 포레스트의 parameter 범위를 정의한다.
RF_params = {
    'n_estimators': [50,100,150,200,300,500,1000],
    'max_features': ['auto', 'sqrt'],
    'max_depth' : [1,2,3,5,6,10],
    'min_samples_leaf': [1, 2, 4],
    'min_samples_split': [2, 3, 5, 10]}

# GridSearchCV를 이용하여 dict에 OBP Randomforest 모델을 저장한다.
OBP_RF_models = {
    'RF': GridSearchCV(
        RandomForestRegressor(random_state=42), param_grid=RF_params, n_jobs=-1
        ).fit(OBP_train.iloc[:,-5:], OBP_train['OBP']).best_estimator_}

# GridSearchCV를 이용하여 dict에 OBP Randomforest 모델을 저장한다.
SLG_RF_models = {
    'RF': GridSearchCV(
        RandomForestRegressor(random_state=42), param_grid=RF_params, n_jobs=-1
        ).fit(SLG_train.iloc[:,-5:], SLG_train['SLG']).best_estimator_}

print(f"걸린시간 : {np.round(time.time() - start,3)}초") # 현재시간 – 시작시간(단위 초)
```

    걸린시간 : 287.431초
    


```python
import xgboost as xgb 
start = time.time() # 시작 시간 저장

# xgboost parmeter space를 정의한다.
XGB_params = {
    'min_child_weight': [1,3, 5,10],
    'gamma': [0.3,0.5, 1, 1.5, 2, 5],
    'subsample': [0.6, 0.8, 1.0],
    'colsample_bytree': [0.6, 0.8, 1.0],
    'max_depth': [3, 4, 5,7,10]}
# GridSearchCV를 통해 parameter를 탐색하게 정의한다.
XGB_OBP_gridsearch = GridSearchCV(xgb.XGBRegressor(random_state=42),
    param_grid=XGB_params, n_jobs=-1) 

XGB_SLG_gridsearch = GridSearchCV(xgb.XGBRegressor(random_state=42),
    param_grid=XGB_params, n_jobs=-1)

# 모델 학습
XGB_OBP_gridsearch.fit(OBP_train.iloc[:,-5:], OBP_train['OBP'])
XGB_SLG_gridsearch.fit(SLG_train.iloc[:,-5:], SLG_train['SLG'])

print(f"걸린시간 : {np.round(time.time() - start,3)}초") # 현재시간 – 시작시간(단위 초)
```

    걸린시간 : 333.998초
    


```python
# 테스트 데이터셋(2018년)의 선수들의 OBP를 예측
Lasso_OBP = OBP_linear_models['Lasso'].predict(OBP_test.iloc[:,-5:])
Ridge_OBP = OBP_linear_models['Ridge'].predict(OBP_test.iloc[:,-5:])
RF_OBP = OBP_RF_models['RF'].predict(OBP_test.iloc[:,-5:])
XGB_OBP = XGB_OBP_gridsearch.predict(OBP_test.iloc[:,-5:])

# test 데이터의 WRMSE 계산
wrmse_score = [wrmse(OBP_test['OBP'], OBP_test['AB'], Lasso_OBP),
               wrmse(OBP_test['OBP'], OBP_test['AB'], Ridge_OBP),
               wrmse(OBP_test['OBP'], OBP_test['AB'], RF_OBP),
               wrmse(OBP_test['OBP'], OBP_test['AB'], XGB_OBP)]

x_lab = ['Lasso', 'Ridge', 'RF', 'XGB']

plt.bar(x_lab, wrmse_score)
plt.title('WRMSE of OBP', fontsize=20)
plt.xlabel('model', fontsize=18)
plt.ylabel('', fontsize=18)
plt.ylim(0,0.5)

# 막대그래프 위에 값을 표시해준다.
for i, v in enumerate(wrmse_score):
    plt.text(i-0.1, v + 0.01, str(np.round(v,3))) # x 좌표, y 좌표, 텍스트를 표현한다.
    
plt.show()
```


    
![png](output_67_0.png)
    



```python
# 테스트 데이터셋(2018년)의 선수들의 SLG를 예측
Lasso_SLG = SLG_linear_models['Lasso'].predict(SLG_test.iloc[:,-5:])
Ridge_SLG = SLG_linear_models['Ridge'].predict(SLG_test.iloc[:,-5:])
RF_SLG = SLG_RF_models['RF'].predict(SLG_test.iloc[:,-5:])
XGB_SLG = XGB_SLG_gridsearch.predict(SLG_test.iloc[:,-5:])

# test데이터 WRMSE 계산
wrmse_score_SLG = [wrmse(SLG_test['SLG'], SLG_test['AB'], Lasso_SLG),
                   wrmse(SLG_test['SLG'], SLG_test['AB'], Ridge_SLG), 
                   wrmse(SLG_test['SLG'], SLG_test['AB'], RF_SLG),
                   wrmse(SLG_test['SLG'], SLG_test['AB'], XGB_SLG)]

x_lab = ['Lasso', 'Ridge', 'RF', 'XGB']

plt.bar(x_lab, wrmse_score_SLG)
plt.title('WRMSE of SLG', fontsize=20)
plt.xlabel('model', fontsize=18)
plt.ylabel('', fontsize=18)
plt.ylim(0, 0.9)

# 막대그래프 위에 값을 표시해준다.
for i, v in enumerate(wrmse_score_SLG):
    plt.text(i-0.1, v + 0.01, str(np.round(v,3))) # x 좌표, y 좌표, 텍스트를 표현한다.
plt.show()
```


    
![png](output_68_0.png)
    


### 1.4.3. 결과 해석과 평가


```python
plt.figure(figsize=(15,6)) # 그래프의 크기 지정
plt.subplot(1,2,1) # 1행 2열의 첫번째(1,1) 그래프

#가로막대 그래프
plt.barh(OBP_train.iloc[:,-5:].columns,OBP_RF_models['RF'].feature_importances_) 

plt.title('Feature importance of RF in OBP')
plt.subplot(1,2,2) # 1행 2열의 두번째(1,2) 그래프
plt.barh(SLG_train.iloc[:,-5:].columns,SLG_RF_models['RF'].feature_importances_)
plt.title('Feature importance of RF in SLG')
plt.show()
```


    
![png](output_70_0.png)
    



```python
# Lasso에서 GridSearchCV로 탐색한 최적의 alpha값 출력
print('Alpha : ', OBP_linear_models['Lasso'].alpha) 
# Lasso model의 선형 계수 값 출력
display(pd.DataFrame(OBP_linear_models['Lasso'].coef_.reshape(-1, 5),
                     columns=OBP_train.iloc[:,-5:].columns, index = ['coefficient']))

print('Alpha : ', SLG_linear_models['Lasso'].alpha)
display(pd.DataFrame(SLG_linear_models['Lasso'].coef_.reshape(-1, 5),
                     columns=SLG_train.iloc[:,-5:].columns, index = ['coefficient']))
```

    Alpha :  0.0001
    


<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>age</th>
      <th>lag1_OBP</th>
      <th>lag2_OBP</th>
      <th>lag3_OBP</th>
      <th>mean_OBP</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>coefficient</th>
      <td>0.003195</td>
      <td>0.018249</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.864913</td>
    </tr>
  </tbody>
</table>
</div>


    Alpha :  0.0001
    


<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>age</th>
      <th>lag1_SLG</th>
      <th>lag2_SLG</th>
      <th>lag3_SLG</th>
      <th>mean_SLG</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>coefficient</th>
      <td>0.0049</td>
      <td>0.081209</td>
      <td>0.0</td>
      <td>-0.0</td>
      <td>0.836453</td>
    </tr>
  </tbody>
</table>
</div>



```python
from sklearn.linear_model import lars_path
plt.figure(figsize=(15,4.8)) # 그래프 크기 지정
plt.subplot(1,2,1) # 1행 2열의 첫 번째(1행, 1열) 그래프 

# OBP 모델의 alpha 값의 변화에 따른 계수의 변화를 alpha, coefs에 저장한다.
alphas, _, coefs = lars_path(OBP_train.iloc[:,-5:].values, OBP_train['OBP'],
                             method='lasso', verbose=True)

# 피처별 alpha 값에 따른 선형 모델 계수의 절댓값의 합 
xx = np.sum(np.abs(coefs.T), axis=1)
# 계수의 절댓값 중 가장 큰 값으로 alpha에 따른 피처의 계수의 합을 나눈다. 
xx /= xx[-1]

plt.plot(xx, coefs.T)
plt.xlabel('|coef| / max|coef|')
plt.ylabel('Coefficients')
plt.title('OBP LASSO Path')
plt.axis('tight')
plt.legend(OBP_train.iloc[:,-5:].columns)

plt.subplot(1,2,2) # 1행 2열의 두 번째(1행, 2열) 그래프
# SLG 모델에서 alpha 값의 변화에 따른 계수의 변화를 alpha, coefs에 저장한다.
alphas, _, coefs = lars_path(SLG_train.iloc[:,-5:].values, SLG_train['SLG'],
                             method='lasso', verbose=True)
xx = np.sum(np.abs(coefs.T), axis=1)
xx /= xx[-1]

plt.plot(xx, coefs.T)
plt.xlabel('|coef| / max|coef|')
plt.ylabel('Coefficients')
plt.title('SLG LASSO Path')
plt.axis('tight')
plt.legend(OBP_train.iloc[:,-5:].columns)
plt.show()
```

    ..


    
![png](output_72_1.png)
    


## 1.5. 성능 향상을 위한 방법
### 1.5.1. 앙상블


```python
print('OBP model averaging: ',
      wrmse(OBP_test['OBP'], OBP_test['AB'], (Lasso_OBP + RF_OBP) / 2))
print('SLG model averaging: ',
      wrmse(SLG_test['SLG'], OBP_test['AB'], (Lasso_SLG + RF_SLG) / 2))
```

    OBP model averaging:  0.33245746520105823
    SLG model averaging:  0.6684541138633256
    

### 1.5.2. 단순화된 모델 생성


```python
# 전처리된 데이터를 다른 곳에 저장
sum_hf_yr_OBP_origin = sum_hf_yr_OBP.copy()

# 전체 희생타 계산
regular_season_df['SF'] = \
    regular_season_df[['H','BB','HBP']].sum(axis=1) / regular_season_df['OBP'] - \
    regular_season_df[['AB','BB','HBP']].sum(axis=1)
regular_season_df['SF'].fillna(0, inplace = True)
regular_season_df['SF'] = regular_season_df['SF'].apply(lambda x : round(x,0))

# 한 타수당 평균 희생타 계산 후 필요한 것만 추출
regular_season_df['SF_1'] = regular_season_df['SF'] / regular_season_df['AB']
regular_season_df_SF = regular_season_df[['batter_name','year','SF_1']]

#day_by_day에서 연도별 선수의 시즌 전반기 출루율과 관련된 성적 합 구하기 + BB, RBI 추가
sum_hf_yr_OBP = \
    day_by_day_df.loc[day_by_day_df['date'] <= 7.18].groupby(['batter_name','year'])[
    'AB','H','BB','HBP','RBI', '2B', '3B', 'HR'].sum().reset_index()
#day_by_day와 regular season에서 구한 희생타 관련 데이터를 합치기
sum_hf_yr_OBP = sum_hf_yr_OBP.merge(regular_season_df_SF, how = 'left',
                                    on=['batter_name','year'])

# 한 타수당 평균 희생타 계산
sum_hf_yr_OBP['SF'] = \
    (sum_hf_yr_OBP['SF_1']*sum_hf_yr_OBP['AB']).apply(lambda x: round(x,0))
sum_hf_yr_OBP.drop('SF_1',axis = 1, inplace = True)

# 전반기 OBP(출루율 계산)
sum_hf_yr_OBP['OBP'] = sum_hf_yr_OBP[['H', 'BB', 'HBP']].sum(axis = 1) / \
                       sum_hf_yr_OBP[['AB', 'BB', 'HBP','SF']].sum(axis = 1)
sum_hf_yr_OBP['OBP'].fillna(0, inplace = True)

# TB 계산
sum_hf_yr_OBP['TB'] =  sum_hf_yr_OBP['H'] + sum_hf_yr_OBP['2B']*2 + \
                       sum_hf_yr_OBP['3B']*3 + sum_hf_yr_OBP['HR']*4
sum_hf_yr_OBP = sum_hf_yr_OBP[['batter_name','year','AB','OBP', 'BB', 'TB', 'RBI']]

# 나이 추가
sum_hf_yr_OBP = sum_hf_yr_OBP.merge(regular_season_df[['batter_name','year','age']],
                                    how = 'left', on=['batter_name','year'])

# 평균 OBP 추가
sum_hf_yr_OBP = sum_hf_yr_OBP.merge(player_OBP_mean[['batter_name', 'mean_OBP']],
                                    how ='left', on="batter_name")
sum_hf_yr_OBP = \
    sum_hf_yr_OBP.loc[~sum_hf_yr_OBP['mean_OBP'].isna()].reset_index(drop=True)
```

    <ipython-input-62-dc2e1e86aa66>:17: FutureWarning: Indexing with multiple keys (implicitly converted to a tuple of keys) will be deprecated, use a list instead.
      day_by_day_df.loc[day_by_day_df['date'] <= 7.18].groupby(['batter_name','year'])[
    


```python
# 각 변수에 대한 1년 전 성적 생성
sum_hf_yr_OBP = lag_function(sum_hf_yr_OBP, "BB", 1)
sum_hf_yr_OBP = lag_function(sum_hf_yr_OBP, "TB", 1)
sum_hf_yr_OBP = lag_function(sum_hf_yr_OBP, "RBI", 1)
sum_hf_yr_OBP = lag_function(sum_hf_yr_OBP, "OBP", 1)

sum_hf_yr_OBP = sum_hf_yr_OBP.dropna() # 결측치 포함한 행 제거

# 변수 리스트 지정
feature_list_1 = ['age', 'lag1_OBP', 'mean_OBP']
feature_list_2 = ['age', 'lag1_BB', 'lag1_TB', 'lag1_RBI','lag1_OBP', 'mean_OBP']
```


```python
# 학습시킬 데이터 30타수 이상만 학습
sum_hf_yr_OBP= sum_hf_yr_OBP.loc[sum_hf_yr_OBP['AB']>=30] 

# 2018년 test로 나누고 나머지는 학습
OBP_train = sum_hf_yr_OBP.loc[sum_hf_yr_OBP['year'] != 2018]
OBP_test = sum_hf_yr_OBP.loc[sum_hf_yr_OBP['year'] == 2018]

# grid search를 이용해 학습한다.
OBP_RF_models_1 = {
    'RF': GridSearchCV(
        RandomForestRegressor(random_state=42), param_grid=RF_params, n_jobs=-1
        ).fit(OBP_train.loc[:,feature_list_1], OBP_train['OBP']).best_estimator_}

OBP_RF_models_2 = {
    'RF': GridSearchCV(
        RandomForestRegressor(random_state=42), param_grid=RF_params, n_jobs=-1
        ).fit(OBP_train.loc[:,feature_list_2], OBP_train['OBP']).best_estimator_}
```


```python
# 예측
RF_OBP_1 = OBP_RF_models_1['RF'].predict(OBP_test.loc[:,feature_list_1])
RF_OBP_2 = OBP_RF_models_2['RF'].predict(OBP_test.loc[:,feature_list_2])

# wrmse 계산
wrmse_score = [wrmse(OBP_test['OBP'],OBP_test['AB'],RF_OBP_1) ,
               wrmse(OBP_test['OBP'],OBP_test['AB'],RF_OBP_2)]
x_lab = ['simple', 'complicate']

plt.bar(x_lab, wrmse_score)
plt.title('WRMSE of OBP', fontsize=20)
plt.xlabel('model', fontsize=18)
plt.ylabel('', fontsize=18)
plt.ylim(0,0.5)
# 막대그래프 위에 값을 표시해준다.
for i, v in enumerate(wrmse_score):
    plt.text(i-0.1, v + 0.01, str(np.round(v,3))) # x 좌표, y좌표, 텍스트 표시
plt.show()
```


    
![png](output_79_0.png)
    



```python
# 최종 제출을 위한 원래 데이터 복구 
sum_hf_yr_OBP = sum_hf_yr_OBP_origin.copy()
```

### 1.5.3. 테스트 데이터 정제


```python
submission = pd.read_csv('C:/dacon/ch01/dataset/submission.csv')
submission['year'] = 2019 # 연도 기입

# 2019년의 Age(나이) 계산
batter_year_born = regular_season_df[['batter_id','batter_name','year_born']].copy()
# 중복선수 제거
batter_year_born = batter_year_born.drop_duplicates().reset_index(drop=True) 

submission = submission.merge(batter_year_born, how='left',
                              on=['batter_id', 'batter_name'])
submission['age'] = submission['year'] - \
                    submission['year_born'].apply(lambda x: int(x[:4]))
submission.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>batter_id</th>
      <th>batter_name</th>
      <th>year</th>
      <th>year_born</th>
      <th>age</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>강경학</td>
      <td>2019</td>
      <td>1992년 08월 11일</td>
      <td>27</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2</td>
      <td>강구성</td>
      <td>2019</td>
      <td>1993년 06월 09일</td>
      <td>26</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3</td>
      <td>강민국</td>
      <td>2019</td>
      <td>1992년 01월 10일</td>
      <td>27</td>
    </tr>
    <tr>
      <th>3</th>
      <td>4</td>
      <td>강민호</td>
      <td>2019</td>
      <td>1985년 08월 18일</td>
      <td>34</td>
    </tr>
    <tr>
      <th>4</th>
      <td>5</td>
      <td>강백호</td>
      <td>2019</td>
      <td>1999년 07월 29일</td>
      <td>20</td>
    </tr>
  </tbody>
</table>
</div>




```python
# submission OBP, SLG 파일 2개 만들어 합치기 
submission_OBP = submission.copy()
submission_SLG = submission.copy()
```


```python
# 앞서 전처리한 데이터를 이용해 평균 성적 기입
submission_OBP = submission_OBP.merge(
    sum_hf_yr_OBP[['batter_name','mean_OBP']].drop_duplicates().reset_index(drop=True),
    how = 'left', on ='batter_name')

# 앞서 전처리한 데이터를 이용해 과거 성적 값 채우기
for i in [1,2,3]:
    temp_lag_df = sum_hf_yr_OBP.loc[
        (sum_hf_yr_OBP['year'] == (2019 - i)) &
        (sum_hf_yr_OBP['AB']>=30),['batter_name','OBP']].copy()
    temp_lag_df.rename(columns={'OBP':'lag'+str(i)+'_OBP'}, inplace=True)
    submission_OBP = submission_OBP.merge(temp_lag_df, how='left', on='batter_name')

submission_OBP.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>batter_id</th>
      <th>batter_name</th>
      <th>year</th>
      <th>year_born</th>
      <th>age</th>
      <th>mean_OBP</th>
      <th>lag1_OBP</th>
      <th>lag2_OBP</th>
      <th>lag3_OBP</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>강경학</td>
      <td>2019</td>
      <td>1992년 08월 11일</td>
      <td>27</td>
      <td>0.337880</td>
      <td>0.423611</td>
      <td>0.285714</td>
      <td>0.222222</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2</td>
      <td>강구성</td>
      <td>2019</td>
      <td>1993년 06월 09일</td>
      <td>26</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3</td>
      <td>강민국</td>
      <td>2019</td>
      <td>1992년 01월 10일</td>
      <td>27</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>3</th>
      <td>4</td>
      <td>강민호</td>
      <td>2019</td>
      <td>1985년 08월 18일</td>
      <td>34</td>
      <td>0.358187</td>
      <td>0.328990</td>
      <td>0.386076</td>
      <td>0.441860</td>
    </tr>
    <tr>
      <th>4</th>
      <td>5</td>
      <td>강백호</td>
      <td>2019</td>
      <td>1999년 07월 29일</td>
      <td>20</td>
      <td>0.356164</td>
      <td>0.355685</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
</div>




```python
submission_OBP['batter_name'].loc[submission_OBP['mean_OBP'].isna()].values
```




    array(['강구성', '강민국', '강상원', '고명성', '김응민', '김종덕', '김주찬', '김철호', '김태연',
           '김태진', '김형준', '나원탁', '남태혁', '박광열', '박기혁', '백민기', '샌즈', '신범수',
           '신성현', '양종민', '윤정우', '이동훈', '이범호', '이병휘', '이성곤', '이인행', '이종욱',
           '이진영', '이창진', '장승현', '장시윤', '전민재', '전병우', '정경운', '정성훈', '조홍석',
           '최원제', '홍창기'], dtype=object)




```python
for batter_name in ["김주찬", "이범호"]:
     # 30타수 이상인 해당선수의 인덱스(Boolean)
    cond_regular = (regular_season_df['AB'] >= 30) & \
                   (regular_season_df['batter_name'] == batter_name)
    
    # 타수를 고려해 평균 OBP 계산
    mean_OBP = sum(regular_season_df.loc[cond_regular,'AB'] * \
                   regular_season_df.loc[cond_regular,'OBP']) / \
               sum(regular_season_df.loc[cond_regular,'AB'])
    
    submission_OBP.loc[(submission_OBP['batter_name'] == batter_name),'mean_OBP'] = \
        mean_OBP
    
    # regular_season_Batter으로부터 1, 2, 3년 전 성적 구하기
    cond_sub = submission_OBP['batter_name'] == batter_name
    submission_OBP.loc[cond_sub,'lag1_OBP'] = regular_season_df.loc[
        (cond_regular) & (regular_season_df['year']==2018),'OBP'].values
    submission_OBP.loc[cond_sub,'lag2_OBP'] = regular_season_df.loc[
        (cond_regular) & (regular_season_df['year']==2017),'OBP'].values
    submission_OBP.loc[cond_sub,'lag3_OBP'] = regular_season_df.loc[
        (cond_regular) & (regular_season_df['year']==2016),'OBP'].values
```


```python
for i in np.where(submission_OBP['batter_name'].isin(["고명성","전민재","김철호","신범수","이병휘"])):
    #submission_OBP.loc[i,'mean_OBP'] = season_OBP_mean.loc[season_OBP_mean['year']==2018,'mean_OBP'].values
    submission_OBP.loc[i,'mean_OBP'] = \
        season_OBP_mean.loc[season_OBP_mean['year']==2018,'mean_OBP']
```


```python
for batter_name in ["전병우","샌즈"]:
    # 30 타수 이상인 해당 선수의 index 추출
    cond_regular = (regular_season_df['AB']>=30) & \
                   (regular_season_df['batter_name']==batter_name) 

# 타수를 고려해 선수의 평균 OBP계산
mean_OBP = sum(regular_season_df.loc[cond_regular,'AB'] * \
               regular_season_df.loc[cond_regular,'OBP']) / \
           sum(regular_season_df.loc[cond_regular,'AB'])
    
submission_OBP.loc[(submission_OBP['batter_name'] == batter_name),'mean_OBP'] = mean_OBP

cond_sub = submission_OBP['batter_name'] == batter_name

# 2018년 데이터로부터 2019년의 1년 전 성적 기입
submission_OBP.loc[cond_sub,'lag1_OBP'] = regular_season_df.loc[
    (cond_regular)&(regular_season_df['year']==2018),'OBP'].values
```


```python
# 평균 성적이 결측치인 선수들에 대해 평균 OBP의 하위 25% 성적 기입
submission_OBP.loc[submission_OBP['mean_OBP'].isna(),'mean_OBP'] = \
    np.quantile(player_OBP_mean['mean_OBP'],0.25)
```


```python
for i in [1,2,3]: 
    # i년 전 OBP 결측치 제거
    submission_OBP = lag_na_fill(submission_OBP, 'OBP', i, season_OBP_mean)
submission_OBP.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>batter_id</th>
      <th>batter_name</th>
      <th>year</th>
      <th>year_born</th>
      <th>age</th>
      <th>mean_OBP</th>
      <th>lag1_OBP</th>
      <th>lag2_OBP</th>
      <th>lag3_OBP</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>강경학</td>
      <td>2019</td>
      <td>1992년 08월 11일</td>
      <td>27</td>
      <td>0.337880</td>
      <td>0.423611</td>
      <td>0.285714</td>
      <td>0.222222</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2</td>
      <td>강구성</td>
      <td>2019</td>
      <td>1993년 06월 09일</td>
      <td>26</td>
      <td>0.304124</td>
      <td>0.329991</td>
      <td>0.330297</td>
      <td>0.336224</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3</td>
      <td>강민국</td>
      <td>2019</td>
      <td>1992년 01월 10일</td>
      <td>27</td>
      <td>0.304124</td>
      <td>0.329991</td>
      <td>0.330297</td>
      <td>0.336224</td>
    </tr>
    <tr>
      <th>3</th>
      <td>4</td>
      <td>강민호</td>
      <td>2019</td>
      <td>1985년 08월 18일</td>
      <td>34</td>
      <td>0.358187</td>
      <td>0.328990</td>
      <td>0.386076</td>
      <td>0.441860</td>
    </tr>
    <tr>
      <th>4</th>
      <td>5</td>
      <td>강백호</td>
      <td>2019</td>
      <td>1999년 07월 29일</td>
      <td>20</td>
      <td>0.356164</td>
      <td>0.355685</td>
      <td>0.356317</td>
      <td>0.362245</td>
    </tr>
  </tbody>
</table>
</div>




```python
# 앞서 전처리한 데이터로 평균 SLG 값 기입
submission_SLG = submission_SLG.merge(
    sum_hf_yr_SLG[['batter_name','mean_SLG']].drop_duplicates().reset_index(drop=True),
    how='left', on='batter_name')

# 앞서 전처리한 데이터에서 과거 SLG 값 채우기
for i in [1,2,3]:
    temp_lag_df = sum_hf_yr_SLG.loc[(sum_hf_yr_SLG['year'] == (2019 - i)) &
        (sum_hf_yr_SLG['AB']>=30),['batter_name','SLG']].copy()
    
    temp_lag_df.rename(columns={'SLG':'lag'+str(i)+'_SLG'}, inplace=True)
    
    submission_SLG = submission_SLG.merge(temp_lag_df, how='left', on='batter_name')
```


```python
submission_SLG['batter_name'].loc[submission_SLG['mean_SLG'].isna()].values
```




    array(['강구성', '강민국', '강상원', '고명성', '김응민', '김종덕', '김주찬', '김철호', '김태연',
           '김태진', '김형준', '나원탁', '남태혁', '박광열', '박기혁', '백민기', '샌즈', '신범수',
           '신성현', '양종민', '윤정우', '이동훈', '이범호', '이병휘', '이성곤', '이인행', '이종욱',
           '이진영', '이창진', '장승현', '장시윤', '전민재', '전병우', '정경운', '정성훈', '조홍석',
           '최원제', '홍창기'], dtype=object)




```python
for batter_name in ["김주찬", "이범호"]:
     # mean_SLG 계산
    cond_regular = (regular_season_df['AB'] >= 30) & \
                   (regular_season_df['batter_name'] == batter_name)
    
    # 타수를 고려해 선수의 평균 SLG 계산
    mean_SLG = sum(regular_season_df.loc[cond_regular,'AB'] * \
                   regular_season_df.loc[cond_regular,'SLG']) / \
               sum(regular_season_df.loc[cond_regular,'AB'])
    
    submission_SLG.loc[(submission_SLG['batter_name'] == batter_name), 'mean_SLG'] = \
        mean_SLG
    
    # regular_season_Batter으로부터 1, 2, 3년 전 성적 구하기
    cond_sub = submission_SLG['batter_name'] == batter_name
    
    submission_SLG.loc[cond_sub,'lag1_SLG'] = regular_season_df.loc[
        (cond_regular) & (regular_season_df['year'] == 2018),'SLG'].values
    submission_SLG.loc[cond_sub,'lag2_SLG'] = regular_season_df.loc[
        (cond_regular) & (regular_season_df['year'] == 2017),'SLG'].values
    submission_SLG.loc[cond_sub,'lag3_SLG'] = regular_season_df.loc[
        (cond_regular) & (regular_season_df['year'] == 2016),'SLG'].values
```


```python
for i in np.where(submission_SLG['batter_name'].isin(
    ["고명성","전민재","김철호","신범수","이병휘"])):
     # 위의 해당 선수들의 평균 SLG 평균값으로 대체
    #submission_SLG.loc[i,'mean_SLG'] = season_SLG_mean.loc[season_SLG_mean['year']==2018,'mean_SLG'].values
    submission_SLG.loc[i,'mean_SLG'] = \
        season_SLG_mean.loc[season_SLG_mean['year']==2018,'mean_SLG']
```


```python
for batter_name in ["전병우","샌즈"]:
    
    # 30타수 이상인 해당선수의 인덱스(Boolean) 
    cond_regular = (regular_season_df['AB']>=30)&\
(regular_season_df['batter_name']==batter_name)

# 타수를 고려한 평균 SLG 계산
mean_SLG = sum(regular_season_df.loc[cond_regular,'AB']*
regular_season_df.loc[cond_regular,'SLG']) / sum(regular_season_df.loc[cond_regular,'AB'])

# 해당 선수의 평균 SLG 값 기입
submission_SLG.loc[(submission_SLG['batter_name'] == batter_name),
'mean_SLG'] = mean_SLG

# 해당 선수의 1년 전 SLG값 기입
cond_sub = submission_SLG['batter_name'] == batter_name
submission_SLG.loc[cond_sub,'lag1_SLG'] = regular_season_df.loc[(cond_regular)&
(regular_season_df['year']==2018),'SLG'].values
```


```python
# 평균 성적이 결측치인 선수들에 대해 평균 SLG의 하위 25% 성적 기입
submission_SLG.loc[submission_SLG['mean_SLG'].isna(),'mean_SLG'] = \
    np.quantile(player_SLG_mean['mean_SLG'],0.25)
```


```python
for i in [1,2,3]:
    # i년 전 SLG 성적 결측치 처리
    submission_SLG = lag_na_fill(submission_SLG, 'SLG', i, season_SLG_mean)
submission_SLG.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>batter_id</th>
      <th>batter_name</th>
      <th>year</th>
      <th>year_born</th>
      <th>age</th>
      <th>mean_SLG</th>
      <th>lag1_SLG</th>
      <th>lag2_SLG</th>
      <th>lag3_SLG</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>강경학</td>
      <td>2019</td>
      <td>1992년 08월 11일</td>
      <td>27</td>
      <td>0.332527</td>
      <td>0.523810</td>
      <td>0.256098</td>
      <td>0.222222</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2</td>
      <td>강구성</td>
      <td>2019</td>
      <td>1993년 06월 09일</td>
      <td>26</td>
      <td>0.326923</td>
      <td>0.391429</td>
      <td>0.385754</td>
      <td>0.385397</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3</td>
      <td>강민국</td>
      <td>2019</td>
      <td>1992년 01월 10일</td>
      <td>27</td>
      <td>0.326923</td>
      <td>0.391429</td>
      <td>0.385754</td>
      <td>0.385397</td>
    </tr>
    <tr>
      <th>3</th>
      <td>4</td>
      <td>강민호</td>
      <td>2019</td>
      <td>1985년 08월 18일</td>
      <td>34</td>
      <td>0.466540</td>
      <td>0.487273</td>
      <td>0.548736</td>
      <td>0.577689</td>
    </tr>
    <tr>
      <th>4</th>
      <td>5</td>
      <td>강백호</td>
      <td>2019</td>
      <td>1999년 07월 29일</td>
      <td>20</td>
      <td>0.523719</td>
      <td>0.532051</td>
      <td>0.484152</td>
      <td>0.483795</td>
    </tr>
  </tbody>
</table>
</div>




```python
# Random Forests를 이용해 OBP 예측
predict_OBP = OBP_RF_models['RF'].predict(submission_OBP.iloc[:,-5:]) 
# Lasso를 이용해 SLG 예측
predict_SLG = SLG_linear_models ['Lasso'].predict(submission_SLG.iloc[:,-5:])
```


```python
final_submission = submission[['batter_id','batter_name']]
final_submission['OPS'] = predict_SLG + predict_OBP # OBP + SLG = OPS 
final_submission.head(10)
```

    <ipython-input-84-400b298e7ac7>:2: SettingWithCopyWarning: 
    A value is trying to be set on a copy of a slice from a DataFrame.
    Try using .loc[row_indexer,col_indexer] = value instead
    
    See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
      final_submission['OPS'] = predict_SLG + predict_OBP # OBP + SLG = OPS
    




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>batter_id</th>
      <th>batter_name</th>
      <th>OPS</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>강경학</td>
      <td>0.503957</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2</td>
      <td>강구성</td>
      <td>0.687933</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3</td>
      <td>강민국</td>
      <td>0.696609</td>
    </tr>
    <tr>
      <th>3</th>
      <td>4</td>
      <td>강민호</td>
      <td>0.958395</td>
    </tr>
    <tr>
      <th>4</th>
      <td>5</td>
      <td>강백호</td>
      <td>0.751592</td>
    </tr>
    <tr>
      <th>5</th>
      <td>8</td>
      <td>강상원</td>
      <td>0.661807</td>
    </tr>
    <tr>
      <th>6</th>
      <td>9</td>
      <td>강승호</td>
      <td>0.505642</td>
    </tr>
    <tr>
      <th>7</th>
      <td>11</td>
      <td>강진성</td>
      <td>0.656007</td>
    </tr>
    <tr>
      <th>8</th>
      <td>12</td>
      <td>강한울</td>
      <td>0.672859</td>
    </tr>
    <tr>
      <th>9</th>
      <td>16</td>
      <td>고명성</td>
      <td>0.640507</td>
    </tr>
  </tbody>
</table>
</div>



### 1.5.4. 반발계수의 변화


```python
# 시즌별 전체 OBP 계산(30타수 이상인 선수들의 기록만 이용)
season_OBP = \
    regular_season_df.loc[regular_season_df['AB'] >= 30].groupby('year').agg(
        {'AB':'sum', 'H':'sum', 'BB':'sum', 'HBP':'sum', 'SF':'sum'}).reset_index()

season_OBP['OBP'] = season_OBP[['H','BB','HBP']].sum(axis=1) / \
                    season_OBP[['AB','BB','HBP','SF']].sum(axis=1)

# 시즌별 전체 SLG 계산(30타수 이상인 선수들의 기록만 이용)
season_SLG = \
    regular_season_df.loc[regular_season_df['AB']>=30].groupby('year').agg(
        {'AB':'sum', 'H':'sum', '2B':'sum', '3B':'sum', 'HR':'sum'}).reset_index()

season_SLG['SLG'] = ((season_SLG['H'] - season_SLG[['2B','3B','HR']].sum(axis=1)) + \
                     season_SLG['2B']*2+season_SLG['3B']*3+ season_SLG['HR']*4) / \
                    season_SLG['AB']

# season_OBP와 season_SLG를 병합 후 season_OPS를 생성해 OPS 계산
season_OPS = pd.merge(season_OBP[['year','OBP']],season_SLG[['year', 'SLG']], on = 'year')
season_OPS['OPS'] = season_OPS['OBP'] + season_OPS['SLG']

# 시즌별 전체 홈런 수와 한 선수당 평균 홈런 수 계산
season_HR = regular_season_df.loc[regular_season_df['AB']>=30].groupby('year').agg(
    {'HR':['sum','mean','count']}).reset_index()
season_HR.columns = ['year', 'sum_HR', 'mean_HR', 'count']

# 기존의 OPS 데이터셋과 병합
season_OPS = season_OPS.merge(season_HR,on ='year' ,how='left')
display(season_OPS.tail())
```


<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>year</th>
      <th>OBP</th>
      <th>SLG</th>
      <th>OPS</th>
      <th>sum_HR</th>
      <th>mean_HR</th>
      <th>count</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>21</th>
      <td>2014</td>
      <td>0.368970</td>
      <td>0.446302</td>
      <td>0.815272</td>
      <td>1013</td>
      <td>7.235714</td>
      <td>140</td>
    </tr>
    <tr>
      <th>22</th>
      <td>2015</td>
      <td>0.362742</td>
      <td>0.434129</td>
      <td>0.796871</td>
      <td>1222</td>
      <td>7.685535</td>
      <td>159</td>
    </tr>
    <tr>
      <th>23</th>
      <td>2016</td>
      <td>0.368325</td>
      <td>0.443871</td>
      <td>0.812196</td>
      <td>1267</td>
      <td>7.918750</td>
      <td>160</td>
    </tr>
    <tr>
      <th>24</th>
      <td>2017</td>
      <td>0.356469</td>
      <td>0.444584</td>
      <td>0.801053</td>
      <td>1450</td>
      <td>8.285714</td>
      <td>175</td>
    </tr>
    <tr>
      <th>25</th>
      <td>2018</td>
      <td>0.355858</td>
      <td>0.455936</td>
      <td>0.811794</td>
      <td>1726</td>
      <td>9.806818</td>
      <td>176</td>
    </tr>
  </tbody>
</table>
</div>



```python
#2018년의 평균 홈런 개수를 시즌별 평균 홈런 수에서 뺀다(HR_diff)
season_OPS['HR_diff'] = season_OPS['mean_HR'] - season_OPS['mean_HR'].iloc[-1]
difference = season_OPS.sort_values(by = 'HR_diff')[['year','OPS','HR_diff']]
display(difference.reset_index(drop=True).head(12))
```


<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>year</th>
      <th>OPS</th>
      <th>HR_diff</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2012</td>
      <td>0.703301</td>
      <td>-5.799242</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2013</td>
      <td>0.748820</td>
      <td>-4.891325</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2006</td>
      <td>0.709301</td>
      <td>-4.806818</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2008</td>
      <td>0.741542</td>
      <td>-4.671987</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2011</td>
      <td>0.735087</td>
      <td>-4.564883</td>
    </tr>
    <tr>
      <th>5</th>
      <td>2007</td>
      <td>0.730715</td>
      <td>-4.451555</td>
    </tr>
    <tr>
      <th>6</th>
      <td>2005</td>
      <td>0.740615</td>
      <td>-3.543660</td>
    </tr>
    <tr>
      <th>7</th>
      <td>2010</td>
      <td>0.770265</td>
      <td>-2.623332</td>
    </tr>
    <tr>
      <th>8</th>
      <td>2014</td>
      <td>0.815272</td>
      <td>-2.571104</td>
    </tr>
    <tr>
      <th>9</th>
      <td>2004</td>
      <td>0.751737</td>
      <td>-2.500696</td>
    </tr>
    <tr>
      <th>10</th>
      <td>2001</td>
      <td>0.821178</td>
      <td>-2.152972</td>
    </tr>
    <tr>
      <th>11</th>
      <td>2015</td>
      <td>0.796871</td>
      <td>-2.121284</td>
    </tr>
  </tbody>
</table>
</div>



```python
# 2000년도 이전의 데이터 수가 충분치 않아 고려하지 않는다.
season_OPS.loc[season_OPS['year']>2000]
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>year</th>
      <th>OBP</th>
      <th>SLG</th>
      <th>OPS</th>
      <th>sum_HR</th>
      <th>mean_HR</th>
      <th>count</th>
      <th>HR_diff</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>8</th>
      <td>2001</td>
      <td>0.366585</td>
      <td>0.454593</td>
      <td>0.821178</td>
      <td>199</td>
      <td>7.653846</td>
      <td>26</td>
      <td>-2.152972</td>
    </tr>
    <tr>
      <th>9</th>
      <td>2002</td>
      <td>0.343798</td>
      <td>0.424739</td>
      <td>0.768536</td>
      <td>274</td>
      <td>8.838710</td>
      <td>31</td>
      <td>-0.968109</td>
    </tr>
    <tr>
      <th>10</th>
      <td>2003</td>
      <td>0.353936</td>
      <td>0.427291</td>
      <td>0.781227</td>
      <td>301</td>
      <td>7.717949</td>
      <td>39</td>
      <td>-2.088869</td>
    </tr>
    <tr>
      <th>11</th>
      <td>2004</td>
      <td>0.344181</td>
      <td>0.407556</td>
      <td>0.751737</td>
      <td>358</td>
      <td>7.306122</td>
      <td>49</td>
      <td>-2.500696</td>
    </tr>
    <tr>
      <th>12</th>
      <td>2005</td>
      <td>0.344851</td>
      <td>0.395764</td>
      <td>0.740615</td>
      <td>357</td>
      <td>6.263158</td>
      <td>57</td>
      <td>-3.543660</td>
    </tr>
    <tr>
      <th>13</th>
      <td>2006</td>
      <td>0.334390</td>
      <td>0.374912</td>
      <td>0.709301</td>
      <td>345</td>
      <td>5.000000</td>
      <td>69</td>
      <td>-4.806818</td>
    </tr>
    <tr>
      <th>14</th>
      <td>2007</td>
      <td>0.346222</td>
      <td>0.384493</td>
      <td>0.730715</td>
      <td>407</td>
      <td>5.355263</td>
      <td>76</td>
      <td>-4.451555</td>
    </tr>
    <tr>
      <th>15</th>
      <td>2008</td>
      <td>0.350637</td>
      <td>0.390905</td>
      <td>0.741542</td>
      <td>457</td>
      <td>5.134831</td>
      <td>89</td>
      <td>-4.671987</td>
    </tr>
    <tr>
      <th>16</th>
      <td>2009</td>
      <td>0.359326</td>
      <td>0.429237</td>
      <td>0.788563</td>
      <td>806</td>
      <td>8.141414</td>
      <td>99</td>
      <td>-1.665404</td>
    </tr>
    <tr>
      <th>17</th>
      <td>2010</td>
      <td>0.356988</td>
      <td>0.413278</td>
      <td>0.770265</td>
      <td>783</td>
      <td>7.183486</td>
      <td>109</td>
      <td>-2.623332</td>
    </tr>
    <tr>
      <th>18</th>
      <td>2011</td>
      <td>0.348382</td>
      <td>0.386705</td>
      <td>0.735087</td>
      <td>650</td>
      <td>5.241935</td>
      <td>124</td>
      <td>-4.564883</td>
    </tr>
    <tr>
      <th>19</th>
      <td>2012</td>
      <td>0.337141</td>
      <td>0.366160</td>
      <td>0.703301</td>
      <td>529</td>
      <td>4.007576</td>
      <td>132</td>
      <td>-5.799242</td>
    </tr>
    <tr>
      <th>20</th>
      <td>2013</td>
      <td>0.355484</td>
      <td>0.393335</td>
      <td>0.748820</td>
      <td>698</td>
      <td>4.915493</td>
      <td>142</td>
      <td>-4.891325</td>
    </tr>
    <tr>
      <th>21</th>
      <td>2014</td>
      <td>0.368970</td>
      <td>0.446302</td>
      <td>0.815272</td>
      <td>1013</td>
      <td>7.235714</td>
      <td>140</td>
      <td>-2.571104</td>
    </tr>
    <tr>
      <th>22</th>
      <td>2015</td>
      <td>0.362742</td>
      <td>0.434129</td>
      <td>0.796871</td>
      <td>1222</td>
      <td>7.685535</td>
      <td>159</td>
      <td>-2.121284</td>
    </tr>
    <tr>
      <th>23</th>
      <td>2016</td>
      <td>0.368325</td>
      <td>0.443871</td>
      <td>0.812196</td>
      <td>1267</td>
      <td>7.918750</td>
      <td>160</td>
      <td>-1.888068</td>
    </tr>
    <tr>
      <th>24</th>
      <td>2017</td>
      <td>0.356469</td>
      <td>0.444584</td>
      <td>0.801053</td>
      <td>1450</td>
      <td>8.285714</td>
      <td>175</td>
      <td>-1.521104</td>
    </tr>
    <tr>
      <th>25</th>
      <td>2018</td>
      <td>0.355858</td>
      <td>0.455936</td>
      <td>0.811794</td>
      <td>1726</td>
      <td>9.806818</td>
      <td>176</td>
      <td>0.000000</td>
    </tr>
  </tbody>
</table>
</div>




```python
final_submission['OPS'] = final_submission['OPS'] - 0.038
display(final_submission.head(10))
final_submission.to_csv('submission.csv', index=False) # 최종 제출파일 생성
```

    <ipython-input-88-db27b64caf8d>:1: SettingWithCopyWarning: 
    A value is trying to be set on a copy of a slice from a DataFrame.
    Try using .loc[row_indexer,col_indexer] = value instead
    
    See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
      final_submission['OPS'] = final_submission['OPS'] - 0.038
    


<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>batter_id</th>
      <th>batter_name</th>
      <th>OPS</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>강경학</td>
      <td>0.465957</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2</td>
      <td>강구성</td>
      <td>0.649933</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3</td>
      <td>강민국</td>
      <td>0.658609</td>
    </tr>
    <tr>
      <th>3</th>
      <td>4</td>
      <td>강민호</td>
      <td>0.920395</td>
    </tr>
    <tr>
      <th>4</th>
      <td>5</td>
      <td>강백호</td>
      <td>0.713592</td>
    </tr>
    <tr>
      <th>5</th>
      <td>8</td>
      <td>강상원</td>
      <td>0.623807</td>
    </tr>
    <tr>
      <th>6</th>
      <td>9</td>
      <td>강승호</td>
      <td>0.467642</td>
    </tr>
    <tr>
      <th>7</th>
      <td>11</td>
      <td>강진성</td>
      <td>0.618007</td>
    </tr>
    <tr>
      <th>8</th>
      <td>12</td>
      <td>강한울</td>
      <td>0.634859</td>
    </tr>
    <tr>
      <th>9</th>
      <td>16</td>
      <td>고명성</td>
      <td>0.602507</td>
    </tr>
  </tbody>
</table>
</div>

